#loading in the necessary libraries -------
library(dplyr)
library(ggplot2)
library(patchwork)
library(ggridges)
library(sf)
library(patchwork)
library(gghalves)
library(patchwork)
library(rnaturalearth)
library(hutils)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

##load data from the overlay analysis - 02_overlay_analysis.R ----
load("output/bioregion_extract.RData") #extracts of the entire bioregions
load("output/can_network_extract.RData") #extracts from the Canadian Marine Conservation Network - inside and outside within each bioregion
load("output/mar_network_extract.RData") #extracts from the Scotian Shelf-Bay of Fundy Draft Network - inside and outside the Maritimes region

#load polygons ----- 
#using the polygon_load function - this load polygons for each function instead of re-writing the code multiple times. Makes things more consistent. 
source("code/polygon_load.R")
polygon_load()

#Plotting levels ----
ocean_ord <- c("Pacific","Arctic","Atlantic")
rcp_ord <- c("RCP 8.5","RCP 2.6")

can_bioregions_centroids <- can_bioregions%>%
  st_centroid()%>%
  st_transform(latlong)%>%
  mutate(lat = st_coordinates(.)[,2],
         ocean = factor(ocean,levels=ocean_ord))%>%
  data.frame()%>%
  arrange(ocean,lat) #arrange them by latitude (centroid) within each bioregion

bioregion_ord <- can_bioregions_centroids%>%pull(region)

mpa_ord <- can_mcn_regions%>%
  mutate(region=factor(region,levels=bioregion_ord))%>%
  arrange(region,clat)%>%pull(NAME_E) #arrange them by latitude (centroid) within each bioregion

#Load plotting abbreviations and set levels for the plotting dataframes
mpa_abbreviations <- read.csv("data/mpa_abbreviations.csv")
region_abbreviations <- read.csv("data/region_abbreviations.csv")
mcn_abbreviations <- read.csv("data/mcn_abbreviations.csv") #these are ones that I made up quickly for every type of closure in the Canadian MCN
mar_abbreviations <- read.csv("data/mar_draft_network_abbreviations.csv")%>%arrange(group,lat) #these are the ones used by Lewis et al. arraged by group and latitute 

#merge in the abbreviations with the extracts and set plotting levels
bioregion_df <- bioregion_extract%>%
  left_join(.,region_abbreviations)%>%
  mutate(region=factor(region,levels=bioregion_ord),
         rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
         rcp=factor(rcp,levels=rcp_ord)) 

can_mcn_df <- can_mcn_extracts%>%
  left_join(.,mcn_abbreviations)%>%
  mutate(name=factor(NAME_E,levels=mpa_ord),
         region=factor(region,levels=bioregion_ord),
         ocean=factor(ocean,levels=ocean_ord),
         rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
         rcp=factor(rcp,levels=rcp_ord))

mar_network_df <- mar_network_extract%>%
  left_join(.,mar_abbreviations%>%dplyr::select(-c(long,lat)))%>%
  mutate(name = factor(mar_name,levels = mar_abbreviations%>%pull(abbreviation)),
         rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
         rcp=factor(rcp,levels=rcp_ord)) 

#now do the comparison to see if the weighting is working in ggplot2

wgt_region_df <- bioregion_df%>% 
  filter(!is.na(adcap))%>%
  mutate(location = "Bioregion",
         NAME_E = NA)%>%
  dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
  rbind(.,can_mcn_df%>%
          filter(!is.na(adcap),location=="inside")%>%
          mutate(location = "Conservation Network")%>%
          dplyr::select(-c(name,Abbreviation,type)))%>%
  data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
  dplyr::select(-geometry)

#unweighted
p1 <- ggplot(data=wgt_region_df,aes(x=region,y=vuln,fill=location))+
  geom_boxplot()+
  theme_bw()+
  facet_wrap(~rcp,nrow=2)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position = "none",
        strip.background = element_rect(fill="white"))+
  labs(title="Unweighted",y="Vulnerability",x="")
#weighted
p2 <- ggplot(data=wgt_region_df,aes(x=region,y=vuln,fill=location,weight=cell_area))+
  geom_boxplot()+
  theme_bw()+
  facet_wrap(~rcp,nrow=2)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position = "none",
        strip.background = element_rect(fill="white"),
        axis.text.y=element_blank(),
  )+
  labs(title="Weighted",
       y="",x="")

combo_comparision_plot <- p1 + p2 + plot_layout(ncol=2,guides="collect")

combo_comparision_plot #view the plot

test_df <- wgt_region_df%>%
  filter(region=="Scotian Shelf",rcp=="RCP 2.6")%>%
  dplyr::select(location,vuln,cell_area)

test_df2 <- weight2rows(test_df,"cell_area") #this essentially creates a very large DF that does the 'weighting' by adding rows

p1_unweighted_SS <- ggplot(test_df,aes(x="Scotian Shelf",y=vuln,fill=location))+
  geom_boxplot()+
  theme_bw()+
  theme(legend.position = "none")+
  labs(title="Unweighted",
       y="",x="")

p1_norm_SS <- ggplot(test_df,aes(x="Scotian Shelf",y=vuln,weight=cell_area,fill=location))+
  geom_boxplot()+
  theme_bw()+
  theme(legend.position = "none")+
  labs(title="Weighted",
       y="",x="")

p2_expanded_SS <- ggplot(test_df2,aes(x="Scotian Shelf",y=vuln,fill=location))+
  geom_boxplot()+
  theme_bw()+
  theme(legend.position = "none")+
  labs(title="Expanded data.frame",
       y="",x="")

SS_comparision_plot <- p1_unweighted_SS + p1_norm_SS + p2_expanded_SS + plot_layout(ncol=3,guides="collect")    

#try with the Strait of Georgia
test_df_SG <- wgt_region_df%>%
  filter(region=="Strait of Georgia",rcp=="RCP 2.6")%>%
  dplyr::select(location,vuln,cell_area)

test_df2_SG <- weight2rows(test_df_SG,"cell_area")


p1_unweighted_SG <- ggplot(test_df_SG,aes(x="Strait of Georgia",y=vuln,fill=location))+
  geom_boxplot()+
  theme_bw()+
  theme(legend.position = "none")+
  labs(title="Unweighted",
       y="",x="")

p1_norm_SG <- ggplot(test_df_SG,aes(x="Strait of Georgia",y=vuln,weight=cell_area,fill=location))+
  geom_boxplot()+
  theme_bw()+
  theme(legend.position = "none")+
  labs(title="Weighted",
       y="",x="")

p2_expanded_SG <- ggplot(test_df2_SG,aes(x="Strait of Georgia",y=vuln,fill=location))+
  geom_boxplot()+
  theme_bw()+
  theme(legend.position = "none")+
  labs(title="Expanded data.frame",
       y="",x="")

SG_comparision_plot <- p1_unweighted_SG + p1_norm_SG + p2_expanded_SG + plot_layout(ncol=3,guides="collect")   

#inspect the plots
SS_comparision_plot
SG_comparision_plot


#interestingly the warning would appear to be an error itself  - https://github.com/tidyverse/ggplot2/issues/5053  