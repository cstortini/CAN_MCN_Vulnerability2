#code to load in the vulnerability data layer

#load library
library(googledrive)
library(sf)
library(dplyr)
library(raster)
library(ggplot2)
library(tidyr)
library(rnaturalearth)
library(viridis)
library(ggnewscale)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
utm_mar <- "+proj=utm +zone=20 +datum=NAD83 +units=km +no_defs +ellps=GRS80 +towgs84=0,0,0"
CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"


#file path
pathdir <- "data/climate_vulnerability.csv"

# #google drive link -- only needs to be done once, but uncomment and give it a try. 
# gd <- "https://drive.google.com/file/d/10t8g9VBbffR3moJjOrfRj9XqnVlgjKhW/view?usp=drivesdk"
# 
# #download the datafile
# drive_download(as_id(gd),path=pathdir)

#load new downloaded data
vul_df <- read.csv(pathdir)%>%
          st_as_sf(coords=c("lon","lat"),crs=latlong,remove=FALSE) #need to check if this is the right projection

#load in shape files for the Canadian/Maritimes marine conservation network (MPAS, OECMS, AOIs)
can_mpas <- read_sf("data/shapefiles/DFO_MPA_MPO_ZPM.shp")%>%
            st_transform(CanProj)%>%
            mutate(type="MPA")

can_oecms <- read_sf("data/shapefiles/DFO_OEABCM_MPO_AMCEZ.shp")%>%
             st_transform(CanProj)%>%
             mutate(type="OECM")

can_network <- rbind(can_mpas%>%dplyr::select(NAME_E,type,geometry), #for plotting the MPAs and OECMs together. 
                     can_oecms%>%dplyr::select(NAME_E,type,geometry))

mar_network <- read_sf("data/shapefiles/networksites_proposed_OEM_MPA_20220617.shp")%>%
               st_transform(CanProj)

can_eez <- read_sf("data/shapefiles/Canada_EEZ.shp")%>%st_transform(CanProj)

#create a map boundary for the analysis based on the Canadian EEZ
can_bounding <- can_eez%>%
                st_transform(latlong)%>%
                st_buffer(5)%>% #10 degree buffer on the Canadian EEZ extent
                st_transform(CanProj)%>%
                st_bbox() #bounding box used for plot limits #will give some warnings but it doesn't distort the bounding box by much and it's only a bounding box anyway

can_bounding_polygon <- can_bounding%>%st_as_sfc()%>%st_as_sf() #convert to an sf polygon

#create a basemap for plotting MPAs
basemap <- rbind(ne_states(country = "Canada",returnclass = "sf")%>%
                   dplyr::select(name_en,geometry)%>%
                   st_as_sf()%>%
                   st_union()%>%
                   st_transform(latlong)%>%
                   st_as_sf()%>%
                   mutate(country="Canada"),
                 ne_states(country = "United States of America",returnclass = "sf")%>%
                   dplyr::select(name_en,geometry)%>%
                   st_as_sf()%>%
                   st_union()%>%
                   st_transform(latlong)%>%
                   st_as_sf()%>%
                   mutate(country="USA"),
                 ne_states(country = "Greenland",returnclass = "sf")%>%
                   dplyr::select(name_en,geometry)%>%
                   st_as_sf()%>%
                   st_union()%>%
                   st_transform(latlong)%>%
                   st_as_sf()%>%
                   mutate(country="USA"))%>%
  st_union()%>%
  st_as_sf()%>%
  st_transform(CanProj)%>%
  st_intersection(.,can_bounding_polygon)

Canada <-  ne_states(country = "Canada",returnclass = "sf")%>%
            dplyr::select(name_en,geometry)%>%
            st_as_sf()%>%
            st_union()%>%
            st_transform(CanProj)%>%
            st_as_sf()%>%
            mutate(country="Canada")

#Show what we are working with

#create a raster from the vulnerability data
test_raster <- vul_df%>%
               data.frame()%>%
               dplyr::select(lon,lat,vuln)%>%
               rasterFromXYZ(.,crs=latlong)%>%
               projectRaster(.,crs=CanProj)%>%
               st_as_stars()



p1 <- ggplot()+
  geom_stars(data=test_raster)+ #add the raster
  scale_fill_viridis_c(na.value="transparent")+
  labs(fill="Vulnerability")+
  
  geom_sf(data=can_eez,fill=NA)+ #add the base layers
  geom_sf(data=basemap)+
  geom_sf(data=Canada)+ #added to show the Can/US border
    
  new_scale_fill() + # new colour scale to differentiate the MPAs
  geom_sf(data=can_network,aes(fill=type),alpha=0.5)+
  scale_fill_manual(values=c("cornflowerblue","coral"))+ #this of course interacts with the colour scale so isn't perfect but for demonstration purposes
  
  theme_bw()+
  coord_sf(expand=0)+
  labs(fill="Type");p1

ggsave("output/example_map.png",p1,height=6,width=6,units="in",dpi=300)






