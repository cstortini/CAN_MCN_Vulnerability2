#code to load in the vulnerability data layer

#load libraries
  library(googledrive)
  library(sf)
  library(dplyr)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
  latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#file paths
  pathdir_26 <- "data/climate_vulnerability_26.csv" #RCP 2.6
  pathdir_85 <- "data/climate_vulnerability_85.csv" #RCP 8.5
  pathdir_bathy <- "data/bathy.csv"

#Google drive links for RCP vulnerability and bathymetry 
  gd_26 <- "https://drive.google.com/file/d/1zsYl4zKLu4Ir6CKVfBj0ho3HC-nxYy7G/view?usp=drivesdk"
  gd_85 <- "https://drive.google.com/file/d/1Nerja0n6XdZS8B3ddh2cb4tMsnrQ94gx/view?usp=drivesdk"
  bathy <- "https://drive.google.com/file/d/1w-XxMtL8lDA7D-Y3_Jn3ZDbr4Ns8sKoP/view?usp=drivesdk"

# download the datafile - only need to do this once so I will comment out once the outputs (pathdir_26, pathdir_85,pathdir_bathy) are synced to github
  #drive_download(as_id(gd_26),path=pathdir_26)
  #drive_download(as_id(gd_85),path=pathdir_85)
  #drive_download(as_id(bathy),path=pathdir_bathy)

#load new downloaded data
vul_df <- rbind(read.csv(pathdir_85),read.csv(pathdir_26))%>%
          mutate(uid = paste(lon,lat,sep="-"))%>%
          arrange(uid)%>% 
          mutate(id = rep(1:(n()/2),each=2))%>%#this is a unique id for each cell 
          arrange(rcp,id)%>%
          dplyr::select(-uid)%>% # not needed
          st_as_sf(coords=c("lon","lat"),crs=latlong,remove=FALSE) #need to check if this is the right projection 

bathy_df <- read.csv(pathdir_bathy)%>%
            st_as_sf(coords=c("lon","lat"),crs=latlong,remove=FALSE)


#Alernative to downloading the processed data from Dan and Google Drive is to run this code
##GEOGRAPHIC DOMAIN
# latd<-c(min(vdata$lat),max(vdata$lat))
# lond<-c(min(vdata$lon),max(vdata$lon))
# 
# ##CRS SYSTEM
# mct<- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
# 
# ##RETREIVE BATHYMETRY FROM NOAA
# library(marmap)
# bth<-getNOAA.bathy(lon1=lond[1],lon2=lond[2],lat1=latd[1],lat2=latd[2], resolution=1)
# bthr<-as.raster(bth)
# crs(bthr) <- mct
# plot(bthr)
# 
# ##EMPTY 0.25 DEGREE RASTER
# crds<-expand.grid(lon=seq(lond[1],lond[2],0.25),
#                   lat=seq(latd[1],latd[2],0.25))
# r0.25deg<-rasterFromXYZ(crds)
# crs(r0.25deg) <- mct
# 
# ##INTERPOLATE BATHYMETRY TO DESIRED GRID SIZE
# bthr<-raster::resample(bthr, r0.25deg, method='ngb')
# 
# ##CONVERT TO FLAT FILE
# xy<-data.frame(coordinates(bthr))
# bthd<-data.frame(lon=xy$x,
#                  lat=xy$y,
#                  bathy=getValues(bthr))


## file metadata - https://www.nature.com/articles/s41558-022-01437-y
  ## adcap = adapative capacity (average among species, weighted by sd - adcapsd)
  ## sens = sensitivity (average among species, weighted by sd - senssd)
  ## expo = exposure (average among species, weighted by sd - exposd)
  ## vuln = vulnerability (average among species, weighted by sd - vulnsd) - review Boyce et al. 2022 for methods and descriptions
  ## nspecies = species richness
  ## tl = average trophic level of the species in the ecosystem (for those that have known trophic levels)
  ## rcp = the emissions scenario (2.6 - strong mitigation ~ paris agreement, 8.5 'buisness as usual' with no reductions in emmisions)




