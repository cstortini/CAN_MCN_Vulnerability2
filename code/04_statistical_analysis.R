## Statistical summaries

#load libraries ---- 
library(dplyr)
library(ggplot2)
library(sf)
library(tidyr)
library(lsmeans)
library(emmeans)
library(rnaturalearth)

sf_use_s2(FALSE)

#Projections ------------
  latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
  CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

#load data -----
    ##load data from the overlay analysis - 02_overlay_analysis.R ----
      load("output/bioregion_extract.RData") #extracts of the entire bioregions
      load("output/can_network_extract.RData") #extracts from the Canadian Marine Conservation Network - inside and outside within each bioregion
      load("output/mar_network_extract.RData") #extracts from the Scotian Shelf-Bay of Fundy Draft Network - inside and outside the Maritimes region
    
    #load polygons ----- 
    #using the polygon_load function - this load polygons for each function instead of re-writing the code multiple times. Makes things more consistent. 
      source("code/polygon_load.R")
      polygon_load()
    
    #Plotting levels ----
      ocean_ord <- c("Pacific","Arctic","Atlantic")
      rcp_ord <- c("RCP 8.5","RCP 2.6")
      
      can_bioregions_centroids <- can_bioregions%>%
        st_centroid()%>%
        st_transform(latlong)%>%
        mutate(lat = st_coordinates(.)[,2],
               ocean = factor(ocean,levels=ocean_ord))%>%
        data.frame()%>%
        arrange(ocean,lat) #arrange them by latitude (centroid) within each bioregion
      
      bioregion_ord <- can_bioregions_centroids%>%pull(region)
      
      mpa_ord <- can_mcn_regions%>%
        mutate(region=factor(region,levels=bioregion_ord))%>%
        arrange(region,clat)%>%pull(NAME_E) #arrange them by latitude (centroid) within each bioregion
    
    #Load plotting abbreviations and set levels for the plotting dataframes
      mpa_abbreviations <- read.csv("data/mpa_abbreviations.csv")
      region_abbreviations <- read.csv("data/region_abbreviations.csv")
      mcn_abbreviations <- read.csv("data/mcn_abbreviations.csv") #these are ones that I made up quickly for every type of closure in the Canadian MCN
      mar_abbreviations <- read.csv("data/mar_draft_network_abbreviations.csv")%>%arrange(group,lat) #these are the ones used by Lewis et al. arraged by group and latitute 
    
    #merge in the abbreviations with the extracts and set plotting levels
      bioregion_df <- bioregion_extract%>%
        left_join(.,region_abbreviations)%>%
        mutate(region=factor(region,levels=bioregion_ord),
               rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
               rcp=factor(rcp,levels=rcp_ord)) 
      
      can_mcn_df <- can_mcn_extracts%>%
        left_join(.,mcn_abbreviations)%>%
        mutate(name=factor(NAME_E,levels=mpa_ord),
               region=factor(region,levels=bioregion_ord),
               ocean=factor(ocean,levels=ocean_ord),
               rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
               rcp=factor(rcp,levels=rcp_ord))
      
      mar_network_df <- mar_network_extract%>%
        left_join(.,mar_abbreviations%>%dplyr::select(-c(long,lat)))%>%
        mutate(name = factor(mar_name,levels = mar_abbreviations%>%pull(abbreviation)),
               rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
               rcp=factor(rcp,levels=rcp_ord)) 
  
  
#Statistical Tests ------------
        
    bioregions <- can_mcn_df%>%
                  filter(!region%in%c("Arctic Archipelago","Hudson Bay Complex","Southern Shelf"))%>% #these only have 'outside' since no PAs are present within extent
                  pull(region)%>%
                  as.character()%>%
                  unique()
      
    fit_extracts <- NULL
    fit_summaries <- NULL
    model_envs <- NULL
    for(i in bioregions){  
      
      message(paste0("Working on ",i))                
      
      #Model - does vulnerability vary between inside/outside and RCP scenarios - is the difference contingent on rcp? 
      fit <- aov(vuln ~ location*rcp,                                     
              data=can_mcn_df%>%data.frame()%>%filter(region==i),
              weights = cell_area)
      
      fit_extracts <- emmip(fit,rcp~location,CIs = TRUE)$data%>% 
                      data.frame()%>%
                      mutate(region=i)%>%
                      rbind(.,fit_extracts)
      
      fit_summaries <- tidy(fit)%>%
                       mutate(region=i)%>%
                       rbind(.,fit_summaries)
      
      model_envs[[i]] <- fit
    }
    
    
    #see the model parameter estimates
    mod_fits <- ggplot(data=fit_extracts,aes(x=location,y=yvar,col=rcp))+
                geom_point()+
                geom_errorbar(aes(ymin=LCL,ymax=UCL),width=0.2)+ #there are the confidence internals from the within region tests
                geom_line(aes(group=rcp))+
                facet_wrap(~region,ncol=3,scales="free")+
                theme_bw()+
                theme(strip.background = element_rect(fill="white"),
                      legend.position = "bottom")+
                labs(x="",y="Vulnerability",col="")
    
    ggsave("output/model_fitplot.png",mod_fits,height=6,width=6,units="in",dpi=300)
      
    #see whether the influence of 'inside' and 'outside' is contingent on the RCP scenario (e.g., is the differnce different between emmisions scenarios)
    fit_summaries%>%filter(term=="location:rcp")%>%mutate(pval=round(as.numeric(p.value),4))
    
    #only in the Arctic does the emmisions scenario temper the difference between inside and outside. 
    
    #you can explore the plot fits using this syntax
    plot(model_envs[["Northern Shelf"]])
    plot(model_envs[["Scotian Shelf"]])
    plot(model_envs[["Strait of Georgia"]])
    plot(model_envs[["Arctic Basin"]])
    plot(model_envs[["Offshore Pacific"]])
    plot(model_envs[["Newfoundland-Labrador Shelves"]])
    plot(model_envs[["Gulf of Saint Lawrence"]])
    plot(model_envs[["Western Arctic"]])
    plot(model_envs[["Eastern Arctic"]])
    
    
    #################--------------------------------------------------
    
    arc_bas <- aov(vuln ~ location*rcp,                                     
               data=can_mcn_df%>%data.frame()%>%filter(region=="Arctic Basin"),
               weights = cell_area)
    
    arc_bas_extracts <- emmip(arc_bas,rcp~location,CIs = TRUE)$data%>% 
      data.frame()%>%
      mutate(region="Arctic Basin")%>%
      #rbind(arc_bas,arc_bas_extracts) #didn't use this but don't know if that's a problem
    
   arc_bas <- ggplot(data=arc_bas_extracts,aes(x=location,y=yvar,col=rcp))+
      geom_point()+
      geom_errorbar(aes(ymin=LCL,ymax=UCL),width=0.2)+ #there are the confidence internals from the within region tests
      geom_line(aes(group=rcp))+
      #facet_wrap(~region,ncol=3,scales="free")+
      theme_bw()+
      theme(strip.background = element_rect(fill="white"),
            legend.position = "bottom")+ ggtitle("Arctic Basin Inetraction Plot")+
      labs(x="",y="Vulnerability",col="")
    
    ggplot(data=arc_bas,aes(x=location,y=rcp))+
      geom_point()
    
    #Linear model for a single bioregion
    arc_bas <- ggplot(data=arc_bas_extracts,aes(x=location,y=yvar,col=rcp))+
      geom_point()+
      geom_errorbar(aes(ymin=LCL,ymax=UCL),width=0.2)+ #there are the confidence internals from the within region tests
      geom_line(aes(group=rcp))+
      theme_bw()+
      theme(strip.background = element_rect(fill="white"),
            legend.position = "bottom")+ ggtitle("Arctic Basin Interaction Plot")+
      labs(x="",y="Vulnerability",col="")
    arc_bas_lm <- lm(vuln ~ location*rcp,                                     
                         data=can_mcn_df%>%data.frame()%>%filter(region=="Arctic Basin"),
                         weights = cell_area)
    
    plot(model_envs[["Arctic Basin"]])
    
    #assumptions
    cooksD <- cooks.distance(model_envs[["Arctic Basin"]])
    influential <- cooksD[(cooksD > (3 * mean(cooksD, na.rm = TRUE)))]
    influential
    
   influential_ids <- vctrs::vec_group_id(influential)
    outliers <- vctrs::vec_group_id(influential_ids,)
    ids_without_outliers <- id %>% anti_join(outliers)
    model2 <- lm(vuln ~ ., data = ids_without_outliers)
    summary(model2)
    
    #linearity----------------------

    #independence--------------------
    
    #homoscedasticity---------------------
    
    #normality---------------------
    sresid <- studres(model_envs[["Scotian Shelf"]]) 
    shapiro.test(sresid)
    
    