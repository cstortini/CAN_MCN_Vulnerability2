#Code for generating some plots to view the data and go make a readme plot. 

#load library
library(googledrive)
library(sf)
library(dplyr)
library(raster)
library(ggplot2)
library(tidyr)
library(rnaturalearth)
library(viridis)
library(ggnewscale)
library(patchwork)
library(stars)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

#load in shape files for the Canadian/Maritimes marine conservation network (MPAS, OECMS, AOIs)
can_mpas <- read_sf("data/shapefiles/DFO_MPA_MPO_ZPM.shp")%>%
  st_transform(CanProj)%>%
  mutate(type="MPA")

can_oecms <- read_sf("data/shapefiles/DFO_OEABCM_MPO_AMCEZ.shp")%>% #eastern canyons is missing
  st_transform(CanProj)%>%
  mutate(type="OECM")

can_network <- rbind(can_mpas%>%dplyr::select(NAME_E,type,geometry), #for plotting the MPAs and OECMs together. 
                     can_oecms%>%dplyr::select(NAME_E,type,geometry))

can_bioregions <- read_sf("data/shapefiles/DFO_Marine_Bioregions_Clipped_1M_CAEAC_2012_05_31.shp")%>%
                  st_transform(CanProj)%>%
                  rowwise()%>%
                  mutate(region=as.character(Legend), #fix up the wierd format that the legends were captured
                         region=strsplit(region,"/",fixed=TRUE)[[1]][1],
                         region=gsub("\\.","",region),
                         region=gsub("[0-9]+","",region),
                         region=trimws(region))%>%
                  filter(region != "Saint-Pierre et Miquelon")

mar_network <- read_sf("data/shapefiles/networksites_proposed_OEM_MPA_20220617.shp")%>%
  st_transform(CanProj)%>%
  mutate(TYPE = ifelse(TYPE == "TBD","Draft",TYPE))

mar_region <- read_sf("data/shapefiles/MaritimesPlanningArea.shp")%>%st_transform(latlong) #note this is slightly different than the bioregions but pretty close

can_eez <- read_sf("data/shapefiles/Canada_EEZ.shp")%>%st_transform(CanProj)

#create a map boundary for the analysis based on the Canadian EEZ
can_bounding <- can_eez%>%
                st_transform(latlong)%>%
                st_buffer(2)%>% #2 degree buffer on the Canadian EEZ extent
                st_transform(CanProj)%>%
                st_bbox() #bounding box used for plot limits #will give some warnings but it doesn't distort the bounding box by much and it's only a bounding box anyway

can_bounding_polygon <- can_bounding%>%st_as_sfc()%>%st_as_sf() #convert to an sf polygon

mar_bound <- mar_region%>%
             st_bbox()

#create a basemap for plotting MPAs
basemap <- rbind(ne_states(country = "Canada",returnclass = "sf")%>%
                   dplyr::select(name_en,geometry)%>%
                   st_as_sf()%>%
                   st_union()%>%
                   st_transform(latlong)%>%
                   st_as_sf()%>%
                   mutate(country="Canada"),
                 ne_states(country = "United States of America",returnclass = "sf")%>%
                   dplyr::select(name_en,geometry)%>%
                   st_as_sf()%>%
                   st_union()%>%
                   st_transform(latlong)%>%
                   st_as_sf()%>%
                   mutate(country="USA"),
                 ne_states(country = "Greenland",returnclass = "sf")%>%
                   dplyr::select(name_en,geometry)%>%
                   st_as_sf()%>%
                   st_union()%>%
                   st_transform(latlong)%>%
                   st_as_sf()%>%
                   mutate(country="USA"))%>%
  st_union()%>%
  st_as_sf()%>%
  st_transform(CanProj)%>%
  st_intersection(.,can_bounding_polygon)

Canada <-  ne_states(country = "Canada",returnclass = "sf")%>%
  dplyr::select(name_en,geometry)%>%
  st_as_sf()%>%
  st_union()%>%
  st_transform(CanProj)%>%
  st_as_sf()%>%
  mutate(country="Canada")

#Show what we are working with

#load the vulnerability data
vul_df <- read.csv("data/climate_vulnerability_85.csv") #this is just RCP8.5

#create a raster from the vulnerability data
test_raster <- vul_df%>%
              data.frame()%>%
              dplyr::select(lon,lat,vuln)%>% #vulnerability from Boyce et al. 2022
              rasterFromXYZ(.,crs=latlong)%>%
              projectRaster(.,crs=CanProj)%>%
              st_as_stars()

p1 <- ggplot()+
  geom_stars(data=test_raster)+ #add the raster
  scale_fill_viridis_c(na.value="transparent")+
  labs(fill="Vulnerability",x="",y="")+
  
  geom_sf(data=can_eez,fill=NA)+ #add the base layers
  geom_sf(data=basemap)+
  geom_sf(data=Canada)+ #added to show the Can/US border
  
  new_scale_fill() + # new colour scale to differentiate the MPAs
  geom_sf(data=can_network,aes(fill=type),alpha=0.5)+
  scale_fill_manual(values=c("cornflowerblue","coral"))+ #this of course interacts with the colour scale so isn't perfect but for demonstration purposes
  
  theme_bw()+
  coord_sf(expand=0,xlim=can_bounding[c(1,3)],ylim=can_bounding[c(2,4)])+
  labs(fill="Type",x="",y="");p1

#for your speed talk
p1_speed <- ggplot()+
  geom_stars(data=test_raster)+ #add the raster
  scale_fill_viridis_c(na.value="transparent")+
  labs(fill="Vulnerability",x="",y="")+
  
  geom_sf(data=basemap,lwd=0.1)+
  geom_sf(data=Canada,fill="grey70",lwd=0.1)+ #added to show the Can/US border
  
  new_scale_fill() + # new colour scale to differentiate the MPAs
  geom_sf(data=can_network,col="brown2",linewidth= 0.5, fill=NA)+
  scale_fill_manual(values=c("cornflowerblue","coral"))+ #this of course interacts with the colour scale so isn't perfect but for demonstration purposes
  
  theme_bw()+
  coord_sf(expand=0,xlim=can_bounding[c(1,3)],ylim=can_bounding[c(2,4)])+
  labs(fill="Type",x="",y="")


ggsave("output/overlay_speed.png",p1_speed,dpi=300,width = 8.98, height=5.75,units="in")

#save the plots
ggsave("output/example_map.png",p1,dpi=300,width = 8.98, height=5.75,units="in")
ggsave("output/climate_vul_RCP85.png",p1_speed,dpi=300,width = 8.98, height=5.75,units="in")

#make a multi-paneled plot for the readme

#just the bioregions
p2 <- ggplot()+
      geom_sf(data=can_eez,fill=NA)+ #add the base layers
      geom_sf(data=can_bioregions,aes(fill=region))+ #canadian marine bioregions 
      geom_sf(data=basemap)+
      geom_sf(data=Canada)+ #added to show the Can/US border
      theme_bw()+
      coord_sf(expand=0,xlim=can_bounding[c(1,3)],ylim=can_bounding[c(2,4)])+
      labs(fill="",x="",y="")+
      scale_fill_viridis(discrete=T);p2
  
ggsave("output/canadian_bioregions.png",p2,dpi=300,width = 8.98, height=5.75,units="in")


#maritimes region draft network

p3 <- ggplot()+
      geom_sf(data=basemap%>%st_transform(latlong))+
      geom_sf(data=Canada%>%st_transform(latlong))+
      geom_sf(data=mar_region,fill=NA)+
      #geom_sf(data=can_bioregions%>%filter(region=="Scotian Shelf")%>%st_transform(latlong),fill=NA)+ #not quite the same as the official network, not sure why
      geom_sf(data=mar_network%>%st_transform(latlong),aes(fill=TYPE))+
      theme_bw()+
      coord_sf(expand=0,xlim=mar_bound[c(1,3)],ylim=mar_bound[c(2,4)]);p3

ggsave("output/maritimes_draft_network.png",p3,dpi=300,width = 8.98, height=5.75,units="in")

#Canadian MCN
p4 <- ggplot()+
      geom_sf(data=can_eez,fill=NA)+
      geom_sf(data=basemap)+
      geom_sf(data=Canada)+
      geom_sf(data=can_network,aes(fill=type))+
      theme_bw()+
      coord_sf(expand=0,xlim=can_bounding[c(1,3)],ylim=can_bounding[c(2,4)])+
      labs(fill="",x="",y="")+
      scale_fill_manual(values=c("cornflowerblue","coral"))+
      labs(x="")


ggsave("output/canada_mcn.png",p4,dpi=300,width = 8.98, height=5.75,units="in")
  
#vulnerability raster overlay

p5 <- ggplot()+
      geom_stars(data=test_raster)+ #add the raster
      scale_fill_viridis_c(na.value="transparent")+
      labs(fill="Vulnerability",x="",y="")+
      geom_sf(data=can_eez,fill=NA)+ #add the base layers
      geom_sf(data=basemap)+
      geom_sf(data=Canada)+ #added to show the Can/US border
      theme_bw()

#stich it together using patchwork
p6 <- p4 + theme(legend.position="none") + labs(title ="A") +
      p2 + theme(legend.position="none") + labs(title = "B") +
      p5 + theme(legend.position="none") + labs(title = "C") +
           geom_sf(data=mar_bound%>%st_as_sfc()%>%st_transform(CanProj),fill=NA) + 
           coord_sf(expand=0,xlim=can_bounding[c(1,3)],ylim=can_bounding[c(2,4)]) + #add the extent of the Maritimes Network
      p3 + theme(legend.position="none") + labs(title = "D")+
      plot_layout(nrow=2)

ggsave("output/Figure1.png",p6,dpi=300,width = 8.98,height=8.98,units="in") #for the readme

#code from Sept. 21 meeting with dummy variable tt for mar_network
tt=vul_df%>%st_transform(CanProj)%>%st_intersection(.,mar_network%>%st_transform(latlong)%>%st_buffer(0.5)%>%st_transform(CanProj))

#dummy variables for other shapefiles (mar_region, can_eez, can_bioregions, can_network, can_oecms, can_mpas)
uu=vul_df%>%st_transform(CanProj)%>%st_intersection(.,mar_region%>%st_transform(latlong)%>%st_buffer(0.5)%>%st_transform(CanProj))
vv=vul_df%>%st_transform(CanProj)%>%st_intersection(.,can_eez%>%st_transform(latlong)%>%st_buffer(0.5)%>%st_transform(CanProj))
ww=vul_df%>%st_transform(CanProj)%>%st_intersection(.,can_bioregions%>%st_transform(latlong)%>%st_buffer(0.5)%>%st_transform(CanProj))
xx=vul_df%>%st_transform(CanProj)%>%st_intersection(.,can_network%>%st_transform(latlong)%>%st_buffer(0.5)%>%st_transform(CanProj))
yy=vul_df%>%st_transform(CanProj)%>%st_intersection(.,can_oecms%>%st_transform(latlong)%>%st_buffer(0.5)%>%st_transform(CanProj))
zz=vul_df%>%st_transform(CanProj)%>%st_intersection(.,can_mpas%>%st_transform(latlong)%>%st_buffer(0.5)%>%st_transform(CanProj))

#trying to visualize the intersections like during our meeting
a <- st_intersection(mar_region,vul_df)
b <- st_intersection(mar_network%>%st_transform(latlong),vul_df)
c <- st_intersection(can_eez%>%st_transform(latlong),vul_df)
d <- st_intersection(can_bioregions%>%st_transform(latlong),vul_df)
e <- st_intersection(can_mpas%>%st_transform(latlong),vul_df)
f <- st_intersection(can_network%>%st_transform(latlong),vul_df)
g <- st_intersection(can_oecms%>%st_transform(latlong),vul_df)

#attempts to make something like p1 on my computer without stars package
p11 <- ggplot()+geom_sf(test_raster)
#generates: Error in `fortify()`:! `data` must be a data frame, or other object coercible by `
#fortify()`, not an S4 object with class RasterLayer.

#just realized the difference between a raster and df: test_raster is a picture of vul_df 
#but raster is an image with colors and df is a table with numbers?
> is.data.frame(test_raster)
[1] FALSE

#making test_raster back into a df?
test_df_conversion <- raster::as.data.frame(test_raster,xy=TRUE)
>is.data.frame(test_df_conversion)
[1] TRUE

#trying to generate a plot...any plot
p1a <- ggplot()+geom_point(data=test_df_conversion) 

#does the original vul_df produce anything?
p1b <- ggplot()+geom_point(data=vul_df)

#nope, back to googling about ggplot2
