#Spatial Intersections

#library(googledrive)
library(sf)
library(dplyr)
library(raster)
library(ggplot2)
library(tidyr)
library(rnaturalearth)
library(patchwork)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

#load polygons
can_eez <- read_sf("data/shapefiles/Canada_EEZ.shp")%>%st_transform(CanProj)

can_bioregions <- read_sf("data/shapefiles/DFO_Marine_Bioregions_Clipped_1M_CAEAC_2012_05_31.shp")%>%
  st_transform(CanProj)%>%
  rowwise()%>%
  mutate(region=as.character(Legend), #fix up the wierd format that the legends were captured
         region=strsplit(region,"/",fixed=TRUE)[[1]][1],
         region=gsub("\\.","",region),
         region=gsub("[0-9]+","",region),
         region=trimws(region))%>%
  filter(region != "Saint-Pierre et Miquelon")%>%
  ungroup()%>%
  st_as_sf()%>%
  rename(ocean=REGION)%>%
  filter(ocean != "Great Lakes")%>%
  dplyr::select(ocean,region,geometry)

mar_network <- read_sf("data/shapefiles/networksites_proposed_OEM_MPA_20220617.shp")%>%
  st_transform(CanProj)%>%
  mutate(type = ifelse(TYPE == "TBD","Draft",TYPE),
         type = ifelse(type == "OEM","OECM",type))


can_mpas <- read_sf("data/shapefiles/DFO_MPA_MPO_ZPM.shp")%>%
  st_transform(CanProj)%>%
  mutate(type="MPA")%>%
  dplyr::select(NAME_E,type,geometry)

Canada <-  ne_states(country = "Canada",returnclass = "sf")%>%
  dplyr::select(name_en,geometry)%>%
  st_as_sf()%>%
  st_union()%>%
  st_transform(CanProj)%>%
  st_as_sf()%>%
  mutate(country="Canada")

#read in the Canadian OECMs and add in the newly announced Eastern Canyons - we can do this with rbind since the sf package treats data in a 'dataframe' approach. 
can_oecms <- rbind(
  
  read_sf("data/shapefiles/DFO_OEABCM_MPO_AMCEZ.shp")%>% #eastern canyons is missing
  st_transform(CanProj)%>%
  mutate(type="OECM")%>%
  dplyr::select(NAME_E,type,geometry),
  
  mar_network%>% #add in the Eastern Canyons
    filter(NAME == "Eastern Canyons Marine Refuge")%>%
    rename(NAME_E = NAME)%>%
    dplyr::select(NAME_E,type,geometry)
  
)

#now add the whole dataset together for the Canadian Marine Conservation Network (MCN)
can_mcn <- rbind(can_mpas,can_oecms)

#read in the datafiles and intersect with the Canadian MCN polys
rcp_26 <- read.csv("data/climate_vulnerability_26.csv")%>%
          st_as_sf(coords=c("lon","lat"),crs=latlong)%>% #converts this to an 'sf' dataframe
          st_transform(CanProj)%>% #convert to the coordinate reference system used by our shapefiles for canada
          st_join(.,can_mcn,left=TRUE)%>%#intersect with Canadian Marine Conservation Areas
          st_join(.,can_bioregions,left=TRUE)%>%#intersect with the Canadian Bioregions and 'Oceans'
          filter(!is.na(ocean)) # gets rid of the points in the French Territory (St. Peirre)

rcp_85 <- read.csv("data/climate_vulnerability_85.csv")%>%
          st_as_sf(coords=c("lon","lat"),crs=latlong)%>% #converts this to an 'sf' dataframe
          st_transform(CanProj)%>% #convert to the coordinate reference system used by our shapefiles for canada
          st_join(.,can_mcn,left=TRUE)%>%#intersect with Canadian Marine Conservation Areas
          st_join(.,can_bioregions,left=TRUE)%>%#intersect with the Canadian Bioregions and 'Oceans'
          filter(!is.na(ocean))# gets rid of the points in the French Territory (St. Peirre)

#plot it to show how it worked

#oceans coloured
p1 <- ggplot()+
  geom_sf(data=rcp_85,aes(col=ocean))+
  geom_sf(data=Canada)+
  theme_bw()+
  theme(legend.position = c(0.8,0.8))

#bioregions coloured
p2 <- ggplot()+
  geom_sf(data=rcp_26,aes(col=region))+
  geom_sf(data=Canada)+
  theme_bw()+
  theme(legend.position = "none") # too many to show on the quick inspection plot

#bring these together into one plot to view
p3 <- p1 + p2 + plot_layout(ncol=2) ; p3

ggsave("output/points_overlaid.png",p3,width=8, height=6,units="in",dpi=300)
