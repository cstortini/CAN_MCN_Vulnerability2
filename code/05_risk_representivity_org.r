## Statistical summaries

#load libraries ---- 
library(dplyr)
library(ggplot2)
library(sf)
library(tidyr)
library(lsmeans)
library(emmeans)
library(rnaturalearth)

sf_use_s2(FALSE)

#Projections ------------
latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

#load data -----
##load data from the overlay analysis - 02_overlay_analysis.R ----
load("output/bioregion_extract.RData") #extracts of the entire bioregions
load("output/can_network_extract.RData") #extracts from the Canadian Marine Conservation Network - inside and outside within each bioregion
load("output/mar_network_extract.RData") #extracts from the Scotian Shelf-Bay of Fundy Draft Network - inside and outside the Maritimes region

#load polygons ----- 
#using the polygon_load function - this load polygons for each function instead of re-writing the code multiple times. Makes things more consistent. 
source("code/polygon_load.R")
polygon_load()

#load the density overlap code
source("code/density_overlap.R")

#Plotting levels ----
ocean_ord <- c("Pacific","Arctic","Atlantic")
rcp_ord <- c("RCP 8.5","RCP 2.6")

can_bioregions_centroids <- can_bioregions%>%
  st_centroid()%>%
  st_transform(latlong)%>%
  mutate(lat = st_coordinates(.)[,2],
         ocean = factor(ocean,levels=ocean_ord))%>%
  data.frame()%>%
  arrange(ocean,lat) #arrange them by latitude (centroid) within each bioregion

bioregion_ord <- can_bioregions_centroids%>%pull(region)

mpa_ord <- can_mcn_regions%>%
  mutate(region=factor(region,levels=bioregion_ord))%>%
  arrange(region,clat)%>%pull(NAME_E) #arrange them by latitude (centroid) within each bioregion

#Load plotting abbreviations and set levels for the plotting dataframes
mpa_abbreviations <- read.csv("data/mpa_abbreviations.csv")
region_abbreviations <- read.csv("data/region_abbreviations.csv")
mcn_abbreviations <- read.csv("data/mcn_abbreviations.csv") #these are ones that I made up quickly for every type of closure in the Canadian MCN
mar_abbreviations <- read.csv("data/mar_draft_network_abbreviations.csv")%>%arrange(group,lat) #these are the ones used by Lewis et al. arraged by group and latitute 

#merge in the abbreviations with the extracts and set plotting levels
bioregion_df <- bioregion_extract%>%
  left_join(.,region_abbreviations)%>%
  mutate(region=factor(region,levels=bioregion_ord),
         rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
         rcp=factor(rcp,levels=rcp_ord)) 

can_mcn_df <- can_mcn_extracts%>%
  left_join(.,mcn_abbreviations)%>%
  mutate(name=factor(NAME_E,levels=mpa_ord),
         region=factor(region,levels=bioregion_ord),
         ocean=factor(ocean,levels=ocean_ord),
         rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
         rcp=factor(rcp,levels=rcp_ord))


#########################################

##CALCULATES (1) AREA UNDER THE PROBABILITY DENSITY FUNCTION FOR ALL RISK SCORES (INSIDE + OUTSIDE OF MPAS); (2) AREA UNDER THE PROBABILITY DENSITY FUNCTION FOR RISK SCORES INSIDE MPAS; (3) AREA THAT JOINTLY OVERLAPS AREAS OF 1 AND 3 - E.G. THE OVERLAPPING PORTION OF BOTH PROBABILITY DENSITIES; (4) 'REPRESENTIVITY' CALCULATED AS THE PROPORTION OF (1) THAT IS MADE UP OF (3)

#########################################

##EXAMPLE TO ILLUSTRATE THE PROCESS

#########################################
##EXTRACT SOME EXAMPLE DATA TO ILLUSTRATE
d<-subset(can_mcn_df,rcp %in% c('RCP 2.6') &
            region %in% c('Offshore Pacific'))

##SUBSET OBSERVATIONS FROM INSIDE MPAS ONLY
data.inside<-subset(d,location %in% c('inside'))

##CALCULATE PROBABILITY DENSITY FUNCTION FOR INSIDE MPAS
dens.inside<-density(data.inside$vuln,na.rm=TRUE,
                     from = 0,
                     to = 1)

##CALCULATE PROBABILITY DENSITY FUNCTION FOR ALL AREAS (INSIDE + OUTSIDE MPAS)
dens.total<-density(d$vuln,na.rm=TRUE,
                    from = 0,
                    to = 1)

##PROBABILITY DENSITY FOR JOINT OVERLAP
joint <- pmin(dens.inside$y, dens.total$y)

##DATA FOR PLOTTING      
df2 <- data.frame(x = rep(dens.inside$x, 3), 
                  y = c(dens.inside$y, dens.total$y, joint),
                  Data = rep(c("Inside MPAs", "Inside + Outside", "Overlap"), each = length(dens.inside$x)))

sum(joint)/sum(dens.total$y)

##VISUALIZE PROBABILITY DISTRIBUTIONS AND JOINT OVERLAP
WA_26<-ggplot(df2, aes(x, y, fill = Data)) + 
  geom_area(position = position_identity(), color = "black") +
  scale_fill_brewer(palette = "Dark2") +
  theme_bw()+
  theme(legend.position='bottom')+
  xlim(0.2,0.7)+ 
  labs(x='Climate risk score',y='Density')+ 
  ggtitle('Offshore Pacific - RCP 2.6')

ggsave("output/risk_representivity_example.png",P1,height=4,width=5,units="in",dpi=300,bg='white')


##FUNCTION TO PLOT OVERLAPPING DENSITIES FOR EACH REGION AND ADD LABELS FOR REPRESENTIVITY TO VERIFY THAT THEY JIVE WITH PLOTS
library(gridExtra)
library(plyr)

f <- NULL

# for RCP 8.5
f<-function(d){
  print(unique(d$region))
  
  ##SUBSET OBSERVATIONS FROM INSIDE MPAS ONLY
  data.inside <- d %>% filter(location=='inside')
  
  ##CALCULATE PROBABILITY DENSITY FUNCTION FOR INSIDE MPAS
  dens.inside<- density(data.inside$vuln,na.rm=TRUE,
                        from = 0,
                        to = 1)
  
  ##CALCULATE PROBABILITY DENSITY FUNCTION FOR ALL AREAS (INSIDE + OUTSIDE MPAS)
  dens.total<-density(d$vuln,na.rm=TRUE,
                      from = 0,
                      to = 1)
  
  ##PROBABILITY DENSITY FOR JOINT OVERLAP
  joint <- pmin(dens.inside$y, dens.total$y)
  
  ##DATA FOR PLOTTING      
  df2 <- data.frame(x = rep(dens.inside$x, 3), 
                    y = c(dens.inside$y, dens.total$y, joint),
                    Data = rep(c("Inside MPAs", "Inside + Outside", "Overlap"), each = length(dens.inside$x)))
  
  lb<-sum(joint)/sum(dens.total$y)
  
  ##VISUALIZE PROBABILITY DISTRIBUTIONS AND JOINT OVERLAP
  l[[i]]<- ggplot(df2, aes(x, y, fill = Data)) + 
    geom_area(position = position_identity(), color = "black") +
    scale_fill_brewer(palette = "Dark2") +
    theme_bw()+
    theme(legend.position='bottom')+
    xlim(0.2,0.9)+ 
    labs(x='Climate risk score',y='Density')+ 
    ggtitle(unique(d$region),"at RCP 8.5")+
    annotate('text',label=round(lb,digits=2),x=0.9,y=max(df2$y))
  
  ##  print(overlap)
  
}
l<-dlply(subset(can_mcn_df,!(region %in% c('Southern Shelf','Hudson Bay Complex','Arctic Archipelago')) & rcp %in% c('RCP 8.5')),.(region),.fun=f)
grid.arrange(l[[1]],l[[2]],l[[3]],l[[4]],l[[5]],l[[6]],l[[7]],l[[8]],l[[9]])


##IN THE BELOW CODE YOU SWITCHED THE NAME OF THE DATA TO 'K' BUT THERE ARE STILL PREVIOUS REFERENCES TO IT AS 'D' - THESE NEED TO BE CONSISTENT

# do this for all other bioregions
#for RCP 2.6
for (i in bioregions){
  message(paste0('working on ', i))
  
  k<-subset(can_mcn_df,rcp %in% c('RCP 2.6') &
              region %in% i)
  
  ##SUBSET OBSERVATIONS FROM INSIDE MPAS ONLY
  data.inside <- k %>% filter(location=='inside')
  
  ##CALCULATE PROBABILITY DENSITY FUNCTION FOR INSIDE MPAS
  dens.inside<- density(data.inside$vuln,na.rm=TRUE,
                        from = 0,
                        to = 1)
  
  ##CALCULATE PROBABILITY DENSITY FUNCTION FOR ALL AREAS (INSIDE + OUTSIDE MPAS)
  dens.total<-density(k$vuln,na.rm=TRUE,
                      from = 0,
                      to = 1)
  
  ##PROBABILITY DENSITY FOR JOINT OVERLAP
  joint <- pmin(dens.inside$y, dens.total$y)
  
  ##DATA FOR PLOTTING      
  df2 <- data.frame(x = rep(dens.inside$x, 3), 
                    y = c(dens.inside$y, dens.total$y, joint),
                    Data = rep(c("Inside MPAs", "Inside + Outside", "Overlap"), each = length(dens.inside$x)))
  
  ##VISUALIZE PROBABILITY DISTRIBUTIONS AND JOINT OVERLAP
  overlap <- ggplot(df2, aes(x, y, fill = Data)) + 
    geom_area(position = position_identity(), color = "black") +
    scale_fill_brewer(palette = "Dark2") +
    theme_bw()+
    theme(legend.position='bottom')+
    xlim(0.2,0.7)+ 
    labs(x='Climate risk score',y='Density')+ 
    ggtitle(i,"at RCP 2.6")
  
  print(overlap)
  
}

#area under the curve?
library(lattice)
library(overlapping)
x <- list(X1 = dens.inside, X2 = dens.total)
out <- overlap(x, plot = TRUE)

df2 <- data.frame(x = rep(dens.inside$x, 3), 
                  y = c(dens.inside$y, dens.total$y, joint),
                  Data = rep(c("Inside MPAs", "Inside + Outside", "Overlap"), each = length(dens.inside$x)))
library(Bolstad)
sintegral()

#########################################

##CALCULATE CLIMATE 'REPRESENTIVITY' USING THE ABOVE METHOD FOR EACH RCP-REGION

#########################################
library(plyr)
library(hrbrthemes)
mfun<-function(d){
  ##DISPLAY REGION
  print(unique(d$region))
  
  ##REQUIRE OBS FROM BOTH INSIDE AND OUTSIDE TO PROCEED
  if(length(unique(d$location))>=2){
    data.inside<-subset(d,location %in% c('inside'))
    dens.inside<-density(data.inside$vuln,na.rm=TRUE,
                         from = 0,
                         to = 1)
    
    dens.total<-density(d$vuln,na.rm=TRUE,
                        from = 0,
                        to = 1)
    
    ##PROBABILITY DENSITY FOR JOINT OVERLAP
    joint <- pmin(dens.inside$y, dens.total$y)
    
    ##PROPORTION TOTAL PROBABILITY DENSITY THAT OVERLAPS WITH INSIDE
    return(sum(joint)/sum(dens.total$y))
  } else NULL
}
rdat<-ddply(can_mcn_df,.(rcp,region),.fun=mfun,.progress='text')
rdat$region<-as.character(rdat$region)

#calculating medians

x <- NULL
for (i in bioregions){
  
  x <- can_mcn_df%>%filter(region==i,rcp=="RCP 2.6")%>%na.omit()
  
  median <- summarise(x,median(vuln))
  
  message(paste0("RCP 2.6 Median for ", i))
  print(median) }

x <- NULL
for (i in bioregions){
  
  x <- can_mcn_df%>%filter(region==i,rcp=="RCP 8.5")%>%na.omit()
  
  median <- summarise(x,median(vuln))
  
  message(paste0("RCP 8.5 Median for ", i))
  print(median) }

median <- c(0.4872215,
            0.30009396,
            0.425224,
            0.3550428,
            0.4224957,
            0.3693655,
            0.3248738,
            0.4074177,
            0.3465837,
            0.4698108,
            0.2659961,
            0.4064814,
            0.3329872,
            0.4118852,
            0.3126771,
            0.2923562,
            0.3774205,
            0.3241637)

#adding in median values to data


rdat_w_med <- cbind(rdat,median)

rdat_w_med <- as.numeric(rdat_w_med$median)

library(hrbrthemes)

P2<-ggplot()+
  geom_point(data=rdat_w_med,aes(x=V1,y=region,color=median,shape=rcp))+
  theme_ipsum(grid_col='gray20')+
  theme(legend.position = "bottom")+
  #scale_color_continuous()+
  #continuous_scale(median,medians,scales::area_pal(),limits = c(0.25,0.50))+
  labs(x="Representivity",y="Region")+
  xlim(0.4,1)

ggsave("output/risk_representivity_byregion.png",P2,height=6,width=10,units="in",dpi=300,bg='white')

no_legend<-ggplot()+
  geom_point(data=rdat_w_med,aes(x=V1,y=region,color=median,shape=rcp, size=4))+ 
  theme_ipsum(grid_col='gray20')+
  theme(legend.position = "none")+
  #scale_color_continuous()+
  #continuous_scale(median,medians,scales::area_pal(),limits = c(0.25,0.50))+
  labs(x="Representivity",y="Region")+
  xlim(0.4,1)
ggsave("output/nolegend_risk_bioregion.png",no_legend,height=6,width=10,units="in",dpi=300,bg='white')

#risk representivity for oceans--
library(plyr)
library(hrbrthemes)
mfun<-function(d){
  ##DISPLAY REGION
  print(unique(d$ocean))
  
  ##REQUIRE OBS FROM BOTH INSIDE AND OUTSIDE TO PROCEED
  if(length(unique(d$location))>=2){
    data.inside<-subset(d,location %in% c('inside'))
    dens.inside<-density(data.inside$vuln,na.rm=TRUE,
                         from = 0,
                         to = 1)
    
    dens.total<-density(d$vuln,na.rm=TRUE,
                        from = 0,
                        to = 1)
    
    ##PROBABILITY DENSITY FOR JOINT OVERLAP
    joint <- pmin(dens.inside$y, dens.total$y)
    
    ##PROPORTION TOTAL PROBABILITY DENSITY THAT OVERLAPS WITH INSIDE
    return(sum(joint)/sum(dens.total$y))
  } else NULL
}
rdat1<-ddply(can_mcn_df,.(rcp,ocean),.fun=mfun,.progress='text')
rdat1$ocean<-as.character(rdat1$ocean)


P3<-ggplot()+
  geom_point(data=rdat1,aes(x=V1,y=ocean,color=rcp,shape=rcp))+ 
  theme_ipsum(grid_col='gray20')+
  theme(legend.position = "bottom")+
  labs(x="Representivity",y="Ocesn Basin")+
  xlim(0.4,1)

ggsave("output/risk_representivity_byocean.png",P3,height=6,width=6,units="in",dpi=300,bg='white')


#risk representivity for Scotian Shelf-Bay of Fundy Draft Network--currently running into error
#ERROR: need at least 2 points to select a bandwidth automatically
library(plyr)
library(hrbrthemes)


m <- na.omit(mar_network_extract)

fun1<-function(m){
  ##DISPLAY LOCATION
  print(unique(m$mar_type))
  
  data.inside<-subset(m,location %in% c('inside'))
  dens.inside<-density(data.inside$vuln,na.rm=TRUE,
                       from = 0,
                       to = 1)
  
  dens.total<-density(m$vuln,na.rm=TRUE,
                      from = 0,
                      to = 1)
  
  ##PROBABILITY DENSITY FOR JOINT OVERLAP
  joint <- pmin(dens.inside$y, dens.total$y)
  
  ##PROPORTION TOTAL PROBABILITY DENSITY THAT OVERLAPS WITH INSIDE
  return(sum(joint)/sum(dens.total$y))
  V1 <- (sum(joint)/sum(dens.total$y))
} 

rdat2<-ddply(mar_network_extract,.(rcp,location),.fun=fun1,.progress='text')
#rdat2$mar_type<-as.character(rdat2$mar_type)
rdat2$rcp<-as.character(rdat2$rcp)
rdat2$location <- as.character(rdat2$location)
rdat2$V1<-as.character(rdat2$V1)

P4<-ggplot()+
  geom_point(data=rdat2,aes(x=V1,y=mar_type,color=rcp,shape=rcp))+ 
  theme_ipsum(grid_col='gray20')+
  theme(legend.position = "bottom")+
  labs(x="Representivity",y="Inside or Outside Draft Network")+
  xlim(0.4,1)

ggsave("output/risk_representivity_SS-BoF.png",P4,height=6,width=6,units="in",dpi=300,bg='white')






###################################################
###################################################
###################################################

##TRYING A DIFFERENT APPROACH TO CALCULATE RISK REPRESENTIVITY - BASED IN THE COUNTS RATHER THAN SMOOTHED DENSITY

######################################################
##EXAMPLE TO SHOW THE APPROACH
d<-subset(can_mcn_df,rcp %in% c('RCP 2.6') &
            region %in% c('Offshore Pacific'))

##SUBSET OBSERVATIONS FROM INSIDE MPAS ONLY
data.inside<-subset(d,location %in% c('inside'))

##CALCULATE HISTOGRAM OF FREQUENCIES OF COUNTS FOR INSIDE MPAS
h.inside<-hist(data.inside$vuln,na.rm=TRUE,breaks=seq(0,1,0.01),plot=FALSE,probability=TRUE)

##CALCULATE HISTOGRAM OF FREQUENCIES FOR ALL AREAS (INSIDE + OUTSIDE MPAS)
h.total<-hist(d$vuln,na.rm=TRUE,breaks=seq(0,1,0.01),plot=FALSE,probability=TRUE)

##PROBABILITY DENSITY FOR JOINT OVERLAP
joint <- pmin(h.inside$count, h.total$count)

##THE MID-POINT OF THE BREAKS - VULNERABILITY VALUES OVER WHICH WE COUNT
x<-h.total$breaks[1:100]+0.005

##DATA FOR PLOTTING      
df2 <- data.frame(x = rep(x, 3), 
                  y = c(h.inside$counts, h.total$counts, joint),
                  Data = rep(c("Inside MPAs", "Inside + Outside", "Overlap"), each = length(x)))

ggplot() + 
  geom_bar(data=subset(df2,Data %in% c('Inside + Outside')), aes(x=x, y=y),stat='identity',fill='green4')+
  geom_bar(data=subset(df2,Data %in% c('Inside MPAs')), aes(x=x, y=y),stat='identity',fill='darkorange4')+
  geom_bar(data=subset(df2,Data %in% c('Overlap')), aes(x=x, y=y),stat='identity',fill='magenta4')+
  theme_bw()+
  theme(legend.position='bottom')+
  xlim(0.2,0.7)+ 
  labs(x='Climate risk score',y='Density')+ 
  ggtitle('Offshore Pacific - RCP 2.6')

rdat85<- rdat%>%filter(rcp=="RCP 8.5")
rdat26<- rdat%>%filter(rcp=="RCP 2.6")

bioregion <-c("Strait of Georgia",
              "Offshore Pacific",
              "Northern Shelf",
              "Eastern Arctic",
              "Western Arctic",
              "Arctic Basin",
              "Scotian Shelf",
              "Gulf of Saint Lawrence",
              "Newfoundland-Labrador Shelves")

RCP85diffRCP26 <- c("0.1116478",
                    "-0.1176884",
                    "-0.016994",
                    "-0.1041335",
                    "0.2143168",
                    "0.0838703",
                    "-0.0049443",
                    "0.0116653",
                    "0.0430453")

diff_RCP_bioregions <- data.frame(bioregion,RCP85diffRCP26)

rdatnew = rdat%>%mutate(diff = RCP85diffRCP26)

arrow_diff_plot <- ggplot(rdat, aes(x=V1, y=region))+
  labs(x="representivity")+
  geom_point(size=5,aes(colour=rcp))+
  geom_path(arrow=arrow(length=unit(0.30,"cm")),ends = "last", type = "closed")+
  theme_bw();arrow_diff_plot
ggsave("output/arrow_plot.png", arrow_diff_plot, height = 6, width = 10, units="in",dpi=300)





##Ocean Basins

d<-subset(arctic_df, rcp %in% c('RCP 2.6'))

##SUBSET OBSERVATIONS FROM INSIDE MPAS ONLY
data.inside<-subset(d,location %in% c('Conservation Network'))

##CALCULATE PROBABILITY DENSITY FUNCTION FOR INSIDE MPAS
dens.inside<-density(data.inside$vuln,na.rm=TRUE,
                     from = 0,
                     to = 1)

##CALCULATE PROBABILITY DENSITY FUNCTION FOR ALL AREAS (INSIDE + OUTSIDE MPAS)
dens.total<-density(d$vuln,na.rm=TRUE,
                    from = 0,
                    to = 1)

##PROBABILITY DENSITY FOR JOINT OVERLAP
joint <- pmin(dens.inside$y, dens.total$y)

##DATA FOR PLOTTING      
df2 <- data.frame(x = rep(dens.inside$x, 3), 
                  y = c(dens.inside$y, dens.total$y, joint),
                  Data = rep(c("Inside MPAs", "Inside + Outside", "Overlap"), each = length(dens.inside$x)))

sum(joint)/sum(dens.total$y)

##VISUALIZE PROBABILITY DISTRIBUTIONS AND JOINT OVERLAP
WA_26<-ggplot(df2, aes(x, y, fill = Data)) + 
  geom_area(position = position_identity(), color = "black") +
  scale_fill_brewer(palette = "Dark2") +
  theme_bw()+
  theme(legend.position='bottom')+
  xlim(0.2,0.7)+ 
  labs(x='Climate risk score',y='Density')+ 
  ggtitle('Offshore Pacific - RCP 2.6')

ggsave("output/risk_representivity_example.png",P1,height=4,width=5,units="in",dpi=300,bg='white')

#make oevrlap %s into a table
percent_overlap <- c(85.975,87.074,57.815,51.426,59.371, 59.179)
rcp <- c(8.5,2.6,8.5,2.6,8.5,2.6)
ocean <- c("Atlantic", "Atlantic", "Arctic", "Arctic", "Pacific", "Pacific")
overlap_oceanbasins <- data.frame(ocean,rcp,percent_overlap)