#loading in the necessary libraries -------
library(dplyr)
library(ggplot2)
library(patchwork)
library(ggridges) #best plots so far 
library(sf)
library(patchwork)
library(gghalves)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

##load data ----
load("data/rcp_26_formatted.RData") # this is from 01_overlay_analysis.R
load("data/rcp_85_formatted.RData") 

#load bioregions ----
can_bioregions <- read_sf("data/shapefiles/DFO_Marine_Bioregions_Clipped_1M_CAEAC_2012_05_31.shp")%>%
  st_transform(CanProj)%>%
  rowwise()%>%
  mutate(region=as.character(Legend), #fix up the wierd format that the legends were captured
         region=strsplit(region,"/",fixed=TRUE)[[1]][1],
         region=gsub("\\.","",region),
         region=gsub("[0-9]+","",region),
         region=trimws(region))%>%
  filter(region != "Saint-Pierre et Miquelon")%>%
  ungroup()%>%
  st_as_sf()%>%
  rename(ocean=REGION)%>%
  filter(ocean != "Great Lakes")%>%
  dplyr::select(ocean,region,geometry)

#set up plotting orders
can_bioregions_centroids <- can_bioregions%>%
  st_centroid()%>%
  st_transform(latlong)%>%
  mutate(lat = st_coordinates(.)[,2],
         ocean = factor(ocean,levels=ocean_ord))%>%
  data.frame()%>%
  arrange(ocean,lat) #arrange them by latitude (centroid) within each bioregion

ocean_ord <- c("Pacific","Arctic","Atlantic")
bioregion_ord <- can_bioregions_centroids%>%pull(region)
rcp_ord <- c("RCP 8.5","RCP 2.6")


#set up plotting orders
ocean_ord <- c("Pacific","Arctic","Atlantic")
bioregion_ord <- can_bioregions_centroids%>%pull(region)
rcp_ord <- c("RCP 8.5","RCP 2.6")

rcp_26 <- rcp_26%>%
          mutate(ocean = factor(ocean,levels=ocean_ord),
                 region = factor(region,levels=bioregion_ord))

rcp_85 <- rcp_85%>%
          mutate(ocean = factor(ocean,levels=ocean_ord),
                 region = factor(region,levels=bioregion_ord))

#Lets combine them ---- 
rcp_data <- rbind(rcp_26,rcp_85)%>%
            mutate(rcp_group = paste0("RCP ",rcp),
                   rcp_group = factor(rcp_group,levels=rcp_ord))

## Ridge plots -----
#plot data by ocean ----
ggplot(rcp_26, aes(x=vuln, y=ocean))+
  geom_density_ridges(fill = "light blue",alpha = 0.5, color = 4, linetype = 1, lwd = 0.25, scale =1)+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="")

ggplot(rcp_26, aes(x=vuln, y=ocean, fill=stat(x)))+
  geom_density_ridges_gradient()+
  scale_fill_viridis_c(name = "vulnerability", option = "C")+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="")+
  theme(legend.position = "none") # in this case because the colours coorespond to the x axis I don't think you need a legend. 

ggplot(rcp_85, aes(x=vuln, y=ocean))+
  geom_density_ridges(fill = "light blue",alpha = 0.5, color = 4, linetype = 1, lwd = 0.25, scale =1)+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="")

ggplot(rcp_85, aes(x=vuln, y=ocean, fill=stat(x)))+
  geom_density_ridges_gradient()+
  scale_fill_viridis_c(name = "vulnerability", option = "C")+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="")+
  theme(legend.position = "none")

#Now lets combine these plots!!
p1 <- ggplot(rcp_data, aes(x=vuln, y=rcp_group, fill=stat(x)))+
  facet_wrap(~ocean,nrow=3)+
  geom_density_ridges_gradient()+
  scale_fill_viridis_c(name = "vulnerability", option = "C")+ #can add a 'alpha=0.7' to make them look transparent but it causes some odd lines to appear, still haven't figured this out. 
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="")+
  theme(legend.position = "none",
        strip.background = element_rect(fill="white"));p1 

ggsave("output/rcp_ocean_comparison.png",p1,height=6,width=6,units="in",dpi=300)


#plot data by region ----
ggplot(rcp_26, aes(x=vuln, y=region, fill=ocean))+ #since the regions are labelled you don't really need a different fill per. 
  geom_density_ridges()+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="")+
  theme(legend.position = "bottom")  

ggplot(rcp_26, aes(x=vuln, y=region, fill=stat(x)))+
  geom_density_ridges_gradient()+
  scale_fill_viridis_c(name = "vulnerability", option = "C")+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="")+
  theme(legend.position = "none") # since the x axis shows corresponds to the colour scale the legend is redundant  

ggplot(rcp_85, aes(x=vuln, y=region, fill=ocean))+
  geom_density_ridges()+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="",fill="")+
  theme(legend.position = "bottom")

ggplot(rcp_85, aes(x=vuln, y=region, fill=stat(x)))+
  geom_density_ridges_gradient()+
  scale_fill_viridis_c(name = "vulnerability", option = "C")+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="",fill="")+
  theme(legend.position = "none")

#now lets combine the plots

#this way has RCP seperated but it's harder to see the differnces within each region
ggplot(rcp_data%>%mutate(rcp_group=factor(rcp_group,levels=rev(rcp_ord))), aes(x=vuln, y=region, fill=stat(x)))+
  facet_wrap(~rcp_group,ncol=2)+
  geom_density_ridges_gradient()+
  scale_fill_viridis_c(name = "vulnerability", option = "C")+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="")+
  theme(legend.position = "none")

#lets get rid of the colour gradient fill and use a transparency to show the overlap per region. note that the ability to facet by ocean doesn't work well here. 
p2 <- ggplot(rcp_data%>%mutate(rcp_group=factor(rcp_group,levels=rev(rcp_ord))), aes(x=vuln, y=region, fill=rcp_group,group=interaction(region,rcp_group)))+
  geom_density_ridges(alpha=0.7)+
  facet_wrap(~ocean,nrow=3,scales = "free_y")+
  scale_fill_manual(values=c("cornflowerblue","coral"))+
  #facet_wrap(~ocean,nrow=3,scales="free_y")+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="",fill="")+
  theme(legend.position = "bottom",
        strip.background = element_rect(fill="white"))

ggsave("output/rcp_bioregion_comparison.png",p2,height=7,width=5.5,units="in",dpi=300)

#Another way to make this plot is using patchwork 
plot_list <- list()
for(i in ocean_ord){
  
  plot_list[[i]] <- ggplot(rcp_data%>%
                           mutate(rcp_group=factor(rcp_group,levels=rev(rcp_ord)))%>%
                           filter(ocean == i), aes(x=vuln, y=region, fill=rcp_group,group=interaction(region,rcp_group)))+
    geom_density_ridges(alpha=0.7)+
    facet_grid(ocean~.)+
    scale_fill_manual(values=c("cornflowerblue","coral"))+
    scale_x_continuous(limits=c(0.2,0.70))+ #this keeps it so each has the same x axis limit
    #facet_wrap(~ocean,nrow=3,scales="free_y")+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",fill="")+
    theme(legend.position = "bottom",
          strip.background = element_rect(fill="white"))
  
}

#patchwork is a package that allows you to seamlessly stich plots together. In this case we ended up 
p3 <- plot_list[["Atlantic"]] + theme(axis.text.x = element_blank()) + labs(x="") + 
      plot_list[["Arctic"]] + theme(axis.text.x = element_blank()) + labs(x="") +
      plot_list[["Pacific"]] + 
      plot_layout(nrow=3,guides="collect") &
      theme(legend.position = 'bottom')


#Quantile plots --- 
ggplot(rcp_26, aes(x = vuln, y= ocean, fill=stat(quantile)))+
  stat_density_ridges(quantile_lines = FALSE, calc_ecdf = TRUE, geom = "density_ridges_gradient")+
  scale_fill_brewer()+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="",fill="Quantile")+
  theme(legend.position = "bottom")

ggplot(rcp_26, aes(x = vuln, y= region, fill=stat(quantile)))+
  stat_density_ridges(quantile_lines = FALSE, calc_ecdf = TRUE, geom = "density_ridges_gradient")+
  scale_fill_brewer(name="")+
  facet_wrap(~ocean,nrow=3,scales="free_y")+ #Personally I find that facets look strange in ridges ... not sure why but it's the way it treats the y axes
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="",fill="Quantile")+
  theme(legend.position = "bottom")

ggplot(rcp_85, aes(x = vuln, y= ocean, fill=stat(quantile)))+
  stat_density_ridges(quantile_lines = FALSE, calc_ecdf = TRUE, geom = "density_ridges_gradient")+
  scale_fill_brewer(name="")+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="",fill="Quantile")+
  theme(legend.position = "bottom")

ggplot(rcp_85, aes(x = vuln, y= region, fill=stat(quantile)))+
  stat_density_ridges(quantile_lines = FALSE, calc_ecdf = TRUE, geom = "density_ridges_gradient")+
  scale_fill_brewer(name="")+
  facet_wrap(~ocean,nrow=3,scales="free_y")+
  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
  labs(x="Vulnerability",y="",fill="Quantile")+
  theme(legend.position = "bottom")




#boxplots ------------
#by ocean basin
ggplot(rcp_26, aes(x = ocean, y = vuln, fill = ocean)) + 
  stat_boxplot(geom = "errorbar", width = 0.25) + 
  geom_boxplot() +
  
  labs(x="",y="Vulnerability")+
  theme_bw()

#another way to show it -- I haven't played with the gghaves package but it is pretty cool
ggplot(rcp_26, aes(x = ocean, y = vuln, fill = ocean)) + 
  geom_half_boxplot(center=TRUE, errorbar.draw=FALSE, 
                    width=0.5, nudge=n) +
  geom_half_violin(side="r", nudge=n) +
  labs(x="",y="Vulnerability",fill="")+
  scale_fill_hue(labels = c("Arctic", "Atlantic", "Pacific"))+
  theme_bw()+
  theme(legend.position = "none")

ggplot(rcp_85, aes(x = ocean, y = vuln, fill = ocean)) + 
  stat_boxplot(geom = "errorbar", width = 0.25) + 
  geom_boxplot() +
  scale_fill_hue(labels = c("Arctic", "Atlantic", "Pacific"))

#combine them!
p4 <- ggplot(rcp_data%>%mutate(rcp_group = factor(rcp_group,levels=rev(rcp_ord))),
       aes(x=ocean,y=vuln,fill=rcp_group,group=interaction(ocean,rcp_group)))+
        geom_boxplot()+
        theme_bw()+
        scale_fill_manual(values=c("cornflowerblue","coral"))+
        labs(x="",y="Vulnerability",fill="")+
        theme(legend.position = "bottom");p4

ggsave("output/rcp_comparison_boxes_oceans.png",p4,height=5,width=6,units="in",dpi=300)

#by region 
region_box_26 <- ggplot(rcp_26, aes(x = region, y = vuln, fill = region)) + 
              stat_boxplot(geom = "errorbar", width = 0.25) + 
              geom_boxplot() + coord_flip()+
              scale_fill_hue(labels = c("Arctic Archipelago", "Arctic Basin", "Eastern Arctic", "Gulf of Saint Lawrence", "Hudson Bay Complex", "Newfoundland-Labrador Shelves", "Northern Shelf", "Offshore Pacific", "Scotian Shelf", "Southern Shelf", "Strait of Georgia", "Western Arctic"))+
              facet_wrap(~ocean,nrow=3,scales="free_y")+
              labs(y="Vulnerability",x="",title = "RCP 2.6")+
              theme_bw()+
              theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
                    strip.background = element_rect(fill="white"));region_box_26


region_box_85 <- ggplot(rcp_85, aes(x = region, y = vuln, fill = region)) + 
                stat_boxplot(geom = "errorbar", width = 0.25) + 
                geom_boxplot() + coord_flip()+
                scale_fill_hue(labels = c("Arctic Archipelago", "Arctic Basin", "Eastern Arctic", "Gulf of Saint Lawrence", "Hudson Bay Complex", "Newfoundland-Labrador Shelves", "Northern Shelf", "Offshore Pacific", "Scotian Shelf", "Southern Shelf", "Strait of Georgia", "Western Arctic"))+
                facet_wrap(~ocean,nrow=3,scales="free_y")+
                labs(y="Vulnerability",x="",title="RCP 8.5")+
                theme_bw()+
                theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
                      strip.background = element_rect(fill="white");region_box_85
                      
region_box_combo_side <- region_box_26 + 
                          region_box_85 + theme(axis.text.y=element_blank()) +
                          plot_layout (ncol=2)

region_box_combo_group <- ggplot(rcp_data, aes(x = region, y = vuln, fill = rcp_group,group=interaction(region,rcp_group))) + 
                  stat_boxplot(geom = "errorbar", width = 0.25) + 
                  geom_boxplot(outlier.size = 0.1) + 
                  coord_flip()+
                  facet_wrap(~ocean,nrow=3,scales="free_y")+
                  labs(y="Vulnerability",x="",fill="")+
                  theme_bw()+
                  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
                        strip.background = element_rect(fill="white"));region_box_combo_group 

ggsave("output/rcp_region_comparison_box.png",region_box_combo_group,height = 7,width=5,units="in",dpi=300)


#by MPA

MPA_box_26 <- ggplot(rcp_26 %>% dplyr::filter( type == "MPA"), aes(x = name, y = vuln, fill = name)) +
  stat_boxplot(geom = "errorbar", width = 0.25) + 
  geom_boxplot() + coord_flip()+
  facet_wrap(~ocean, nrow = 3, scale = "free_y")+
  labs(y = "Vulnerability", x = "", title = "RCP 2.6")+
  theme_bw()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c("TUV MPA","TN MPA","ST. A MPA", "SGK MPA", "LAUR MPA", "QC MPA", "GUL MPA", "BDA MPA", "AN MPA")); MPA_box_26 

MPA_box_85 <- ggplot(rcp_85 %>% dplyr::filter( type == "MPA"), aes(x = name, y = vuln, fill = name)) +
  stat_boxplot(geom = "errorbar", width = 0.25) + 
  geom_boxplot() + coord_flip()+
  facet_wrap(~ocean, nrow = 3, scale = "free_y")+
  labs(y = "Vulnerability", x = "", title = "RCP 8.5")+
  theme_bw()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c("TUV MPA","TN MPA","ST. A MPA", "SGK MPA", "LAUR MPA", "QC MPA", "GUL MPA", "BDA MPA", "AN MPA")); MPA_box_26 


ggplot(rcp_26 %>% dplyr::filter( type == "MPA"), aes(x = name, y = vuln, fill = name)) +
  stat_boxplot(geom = "errorbar", width = 0.25) + coord_flip()+
    theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  geom_boxplot() +
  scale_x_discrete(labels = c("TUV MPA","TN MPA","ST. A MPA", "SGK MPA", "LAUR MPA", "QC MPA", "GUL MPA", "BDA MPA", "AN MPA")) 
  
ggplot(rcp_85 %>% dplyr::filter( type == "MPA"), aes(x = name, y = vuln, fill = name)) +
    stat_boxplot(geom = "errorbar", width = 0.25) + coord_flip()+
    theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
    geom_boxplot()+
  scale_x_discrete(labels = c("TUV MPA","TN MPA","ST. A MPA", "SGK MPA", "LAUR MPA", "QC MPA", "GUL MPA", "BDA MPA", "AN MPA")) 


#trying to plot MPAs with regions...

#making it 2 separate datasets
dta1 = subset(rcp_26, select = c("vuln", "vulnsd", "ocean", "region")) #for the regions
dta2 = subset(rcp_26 %>% dplyr::filter( type == "MPA"), select = c("vuln", "vulnsd", "ocean", "type", "name")) #for the MPAs

#trying to merge the 2 subsets back into 1 coherent graph  ## RS -- I didn't actually know you could do this ... cool!
ggplot(dta1, aes(x = region, y = vuln, fill = region)) + 
  stat_boxplot(geom = "errorbar", width = 0.25) + 
  geom_boxplot() + coord_flip()+
  scale_fill_hue(labels = c("Arctic Archipelago", "Arctic Basin", "Eastern Arctic", "Gulf of Saint Lawrence", "Hudson Bay Complex", "Newfoundland-Labrador Shelves", "Northern Shelf", "Offshore Pacific", "Scotian Shelf", "Southern Shelf", "Strait of Georgia", "Western Arctic"))+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  facet_wrap(~ocean,nrow=3,scales="free_y")+
  ggplot(dta2, aes(x = name, y = vuln, fill = name))+
  stat_boxplot(geom = "errorbar", width = 0.25) + 
  geom_boxplot() + coord_flip()+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
#now to get them on the same graph - success!!
ggplot() + 
  stat_boxplot(geom = "errorbar", width = 0.25) + 
  geom_boxplot(data = dta1, aes(x = region, y = vuln, fill = region)) + coord_flip()+
  scale_fill_hue(labels = c("Arctic Archipelago", "Arctic Basin", "Eastern Arctic", "Gulf of Saint Lawrence", "Hudson Bay Complex", "Newfoundland-Labrador Shelves", "Northern Shelf", "Offshore Pacific", "Scotian Shelf", "Southern Shelf", "Strait of Georgia", "Western Arctic"))+
  theme(legend.position = "none",  axis.title.y = element_blank(), axis.text.y = element_text(size = 5))+
  facet_wrap(~ocean,nrow=3,scales="free_y")+
  stat_boxplot(geom = "errorbar", width = 0.25) + 
  geom_boxplot(data = dta2, aes(x = name, y = vuln, fill = name)) + 
  coord_flip()+
  theme(legend.position = "none", axis.title.y = element_blank(), axis.text.y = element_text(size = 5))



#extra stuff ----
# #looking at tail probabilities - I don't exactly know what this does ## agreed I don't think these show much 
# 
# ggplot(rcp_26, aes(vuln, y = ocean,
#                    fill = 0.5 - abs(0.5 - stat(ecdf)))) +
#   stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE) +
#   scale_fill_gradient(low = "white", high = "#87CEFF",
#                       name = "Tail prob.")
# 
# ggplot(rcp_26, aes(vuln, y = region,
#                    fill = 0.5 - abs(0.5 - stat(ecdf)))) +
#   stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE) +
#   scale_fill_gradient(low = "white", high = "#87CEFF",
#                       name = "Tail prob.")
# 
# ggplot(rcp_85, aes(vuln, y = ocean,
#                    fill = 0.5 - abs(0.5 - stat(ecdf)))) +
#   stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE) +
#   scale_fill_gradient(low = "white", high = "#87CEFF",
#                       name = "Tail prob.")
# 
# ggplot(rcp_85, aes(vuln, y = region,
#                    fill = 0.5 - abs(0.5 - stat(ecdf)))) +
#   stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE) +
#   scale_fill_gradient(low = "white", high = "#87CEFF",
#                       name = "Tail prob.")

