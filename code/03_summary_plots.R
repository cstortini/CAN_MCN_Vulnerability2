#loading in the necessary libraries -------
library(dplyr)
library(ggplot2)
library(patchwork)
library(ggridges)
library(sf)
library(patchwork)
library(gghalves)
library(patchwork)
library(rnaturalearth)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
  latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
  CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

##load data from the overlay analysis - 02_overlay_analysis.R ----
  load("output/bioregion_extract.RData") #extracts of the entire bioregions
  load("output/can_network_extract.RData") #extracts from the Canadian Marine Conservation Network - inside and outside within each bioregion
  load("output/mar_network_extract.RData") #extracts from the Scotian Shelf-Bay of Fundy Draft Network - inside and outside the Maritimes region

#Plotting levels ----
      ocean_ord <- c("Pacific","Arctic","Atlantic")
      rcp_ord <- c("RCP 8.5","RCP 2.6")
      
      can_bioregions_centroids <- can_bioregions%>%
        st_centroid()%>%
        st_transform(latlong)%>%
        mutate(lat = st_coordinates(.)[,2],
               ocean = factor(ocean,levels=ocean_ord))%>%
        data.frame()%>%
        arrange(ocean,lat) #arrange them by latitude (centroid) within each bioregion
      
      bioregion_ord <- can_bioregions_centroids%>%pull(region)
      
      mpa_ord <- can_mcn_regions%>%
                           mutate(region=factor(region,levels=bioregion_ord))%>%
                           arrange(region,clat)%>%pull(NAME_E) #arrange them by latitude (centroid) within each bioregion
    
    #Load plotting abbreviations and set levels for the plotting dataframes
      mpa_abbreviations <- read.csv("data/mpa_abbreviations.csv")
      region_abbreviations <- read.csv("data/region_abbreviations.csv")
      mcn_abbreviations <- read.csv("data/mcn_abbreviations.csv") #these are ones that I made up quickly for every type of closure in the Canadian MCN
      mar_abbreviations <- read.csv("data/mar_draft_network_abbreviations.csv")%>%arrange(group,lat) #these are the ones used by Lewis et al. arraged by group and latitute 
      
    #merge in the abbreviations with the extracts and set plotting levels
      bioregion_df <- bioregion_extract%>%
                      left_join(.,region_abbreviations)%>%
                      mutate(region=factor(region,levels=bioregion_ord),
                             rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                             rcp=factor(rcp,levels=rcp_ord)) 
      
      can_mcn_df <- can_mcn_extracts%>%
                    left_join(.,mcn_abbreviations)%>%
                    mutate(name=factor(NAME_E,levels=mpa_ord),
                           region=factor(region,levels=bioregion_ord),
                           ocean=factor(ocean,levels=ocean_ord),
                           rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                           rcp=factor(rcp,levels=rcp_ord))
      
      mar_network_df <- mar_network_extract%>%
                        left_join(.,mar_abbreviations%>%dplyr::select(-c(long,lat)))%>%
                        mutate(name = factor(mar_name,levels = mar_abbreviations%>%pull(abbreviation)),
                               rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                               rcp=factor(rcp,levels=rcp_ord)) 

#load polygons ----- 
#using the polygon_load function - this load polygons for each function instead of re-writing the code multiple times. Makes things more consistent. 
  source("code/polygon_load.R")
  polygon_load()
  
  
## Ridge plots ----- ** note that the ridge plots don't currently do weighted ridgelines, but there seem to be some work arounds that maybe you can try (https://github.com/wilkelab/ggridges/issues/5)
  #plot data by ocean ----
  
  #data.frames that have all the values for the region and then for the site. Note that we can't use the cell_area to weight these values so the plots can be sort of misleading
  atlantic_df <- bioregion_df%>% 
                 filter(!is.na(adcap),ocean=="Atlantic")%>%
                 mutate(location = "Bioregion",
                        NAME_E = NA)%>%
                 dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                 rbind(.,can_mcn_df%>%
                         filter(!is.na(adcap),ocean=="Atlantic",location=="inside")%>%
                         mutate(location = "Conservation Network")%>%
                         dplyr::select(-c(name,Abbreviation,type)))
  
  pacific_df <- bioregion_df%>% 
                filter(!is.na(adcap),ocean=="Pacific")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),ocean=="Pacific",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))
  
  arctic_df <- bioregion_df%>% 
                filter(!is.na(adcap),ocean=="Arctic")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),ocean=="Arctic",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))
  
  atlantic_plot <- ggplot(data=atlantic_df, aes(x=vuln, y=ocean,fill=location,group=location))+
                    geom_density_ridges(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25, scale =1)+
                    facet_grid(rcp~.)+
                    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
                    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
                    labs(x="Vulnerability",y="",title="Atlantic ocean",fill="")+
                    theme(axis.text.y=element_blank(),
                          legend.position = "none",
                          strip.background = element_rect(fill="white"))
  
  arctic_plot <- ggplot(data=arctic_df, aes(x=vuln, y=ocean,fill=location,group=location))+
                  geom_density_ridges(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25, scale =1)+
                  facet_grid(rcp~.)+
                  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
                  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
                  labs(x="Vulnerability",y="",title="Arctic ocean",fill="")+
                  theme(axis.text.y=element_blank(),
                        legend.position = "none",
                        strip.background = element_rect(fill="white"))
  
  pacific_plot <- ggplot(data=pacific_df, aes(x=vuln, y=ocean,fill=location,group=location))+
                  geom_density_ridges(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25, scale =1)+
                  facet_grid(rcp~.)+
                  theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
                  coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
                  labs(x="Vulnerability",y="",title="Pacific ocean",fill="")+
                  theme(axis.text.y=element_blank(),
                        legend.position = "none",
                        strip.background = element_rect(fill="white"))
  
  
  combo_plot <- atlantic_plot + theme(axis.text.x = element_blank(),
                                      axis.title.x=element_blank()) + labs(x="") + 
                arctic_plot + theme(axis.text.x = element_blank(),
                                    axis.title.x=element_blank()) + labs(x="") + 
                pacific_plot + plot_layout(nrow=3,guides="collect") &
                theme(legend.position = 'bottom')
  
  ggsave("output/ocean_vulnerability_rcp_combo.png",combo_plot,height=8,width=6,units="in",dpi=300)
    
  
  #plotting by bioregion
  
  #trying to separate out the bioregions by adjusting the dataframes

  wgt_region_85_df
  
  bioregion_df%>%select(c(vuln,bathy, region, cell_area, ab_region, geometry))%>% 
                
    
  

   
  bioregion_df <- bioregion_extract%>%
    left_join(.,region_abbreviations)%>%
    mutate(region=factor(region,levels=bioregion_ord),
           rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
           rcp=factor(rcp,levels=rcp_ord)) 
  
  atlantic_df <- bioregion_df%>% 
    filter(!is.na(adcap),rcp=="RCP 2.6")%>%
    mutate(location = "Bioregion",
           NAME_E = NA)%>%
    dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
    rbind(.,can_mcn_df%>%
            filter(!is.na(adcap),ocean=="Atlantic",location=="inside")%>%
            mutate(location = "Conservation Network")%>%
            dplyr::select(-c(name,Abbreviation,type)))
  
  bioregion_plot <- ggplot(data = bioregion_df, aes(x=vuln, y= region, fill= region, group = region))+
                    geom_density_ridges(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25, scale =1)+
                    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
                    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
                    labs(x="Vulnerability",y="",title="Bioregions",fill="")+
                    theme(axis.text.y=element_blank(),
                    legend.position = "none",
                    strip.background = element_rect(fill="white"))
  
  ggplot(bioregion_df, aes(x = ab_region, y = vuln, fill = ab_region)) + 
    stat_boxplot(geom = "errorbar", width = 0.25) + 
    geom_boxplot() + coord_flip()+
    #scale_fill_hue(labels = c("Arctic Archipelago", "Arctic Basin", "Eastern Arctic", "Gulf of Saint Lawrence", "Hudson Bay Complex", "Newfoundland-Labrador Shelves", "Northern Shelf", "Offshore Pacific", "Scotian Shelf", "Southern Shelf", "Strait of Georgia", "Western Arctic"))+
    facet_wrap(~ocean,nrow=3,scales="free_y")+
    labs(y="Vulnerability",x="",title="RCP 8.5")+
    theme_bw()+
    theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
          strip.background = element_rect(fill="white"))
  
 