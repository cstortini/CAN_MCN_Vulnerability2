#loading in the necessary libraries -------
library(dplyr)
library(ggplot2)
library(patchwork)
library(ggridges)
library(sf)
library(patchwork)
library(gghalves)
library(patchwork)
library(rnaturalearth)
library(viridis)
library(tidyverse)
library(tidyr)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
  latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
  CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

##load data from the overlay analysis - 02_overlay_analysis.R ----
  load("output/bioregion_extract.RData") #extracts of the entire bioregions
  load("output/can_network_extract.RData") #extracts from the Canadian Marine Conservation Network - inside and outside within each bioregion
  load("output/mar_network_extract.RData") #extracts from the Scotian Shelf-Bay of Fundy Draft Network - inside and outside the Maritimes region

#load polygons ----- 
  #using the polygon_load function - this load polygons for each function instead of re-writing the code multiple times. Makes things more consistent. 
  source("code/polygon_load.R")
  polygon_load()
  
#Plotting levels ----
      ocean_ord <- c("Pacific","Arctic","Atlantic")
      rcp_ord <- c("RCP 8.5","RCP 2.6")
      
      can_bioregions_centroids <- can_bioregions%>%
        st_centroid()%>%
        st_transform(latlong)%>%
        mutate(lat = st_coordinates(.)[,2],
               ocean = factor(ocean,levels=ocean_ord))%>%
        data.frame()%>%
        arrange(ocean,lat) #arrange them by latitude (centroid) within each bioregion
      
      bioregion_ord <- can_bioregions_centroids%>%pull(region)
      
      mpa_ord <- can_mcn_regions%>%
                           mutate(region=factor(region,levels=bioregion_ord))%>%
                           arrange(region,clat)%>%pull(NAME_E) #arrange them by latitude (centroid) within each bioregion
    
    #Load plotting abbreviations and set levels for the plotting dataframes
      mpa_abbreviations <- read.csv("data/mpa_abbreviations.csv")
      region_abbreviations <- read.csv("data/region_abbreviations.csv")
      mcn_abbreviations <- read.csv("data/mcn_abbreviations.csv") #these are ones that I made up quickly for every type of closure in the Canadian MCN
      mar_abbreviations <- read.csv("data/mar_draft_network_abbreviations.csv")%>%arrange(group,lat) #these are the ones used by Lewis et al. arraged by group and latitute 
      
    #merge in the abbreviations with the extracts and set plotting levels
      bioregion_df <- bioregion_extract%>%
                      left_join(.,region_abbreviations)%>%
                      mutate(region=factor(region,levels=bioregion_ord),
                             rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                             rcp=factor(rcp,levels=rcp_ord)) 
      
      can_mcn_df <- can_mcn_extracts%>%
                    left_join(.,mcn_abbreviations)%>%
                    mutate(name=factor(NAME_E,levels=mpa_ord),
                           region=factor(region,levels=bioregion_ord),
                           ocean=factor(ocean,levels=ocean_ord),
                           #rcp=ifelse(rcp==2.6"RCP 2.6","RCP 8.5"),
                           rcp=factor(rcp,levels=rcp_ord))
      
      mar_network_df <- mar_network_extract%>%
                        left_join(.,mar_abbreviations%>%dplyr::select(-c(long,lat)))%>%
                        mutate(name = factor(mar_name,levels = mar_abbreviations%>%pull(abbreviation)),
                               rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                               rcp=factor(rcp,levels=rcp_ord)) 
  
  
#---------------OCEAN -------------------------------------------------------------------------------------------------------------
 ## Ridge plots ----- ** note that the ridge plots don't currently do weighted ridgelines, but there seem to be some work arounds that maybe you can try (https://github.com/wilkelab/ggridges/issues/5)
  #data.frames that have all the values for the region and then for the site. Note that we can't use the cell_area to weight these values so the plots can be sort of misleading
  atlantic_df <- bioregion_df%>% 
                 filter(!is.na(adcap),ocean=="Atlantic")%>%
                 mutate(location = "Bioregion",
                        NAME_E = NA)%>%
                 dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                 rbind(.,can_mcn_df%>%
                         filter(!is.na(adcap),ocean=="Atlantic",location=="inside")%>%
                         mutate(location = "Conservation Network")%>%
                         dplyr::select(-c(name,Abbreviation,type)))
  
  pacific_df <- bioregion_df%>% 
                filter(!is.na(adcap),ocean=="Pacific")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),ocean=="Pacific",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))
  
  arctic_df <- bioregion_df%>% 
                filter(!is.na(adcap),ocean=="Arctic")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),ocean=="Arctic",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))
  
  # oceans plots with weighting
  atlantic_plot2 <- ggplot(data=atlantic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    geom_vline(data= atlantic_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = mean(vuln), color = "Conservation Network"))+
    geom_vline(data= atlantic_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = mean(vuln), color = "Bioregion"))+
    geom_vline(data= atlantic_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = mean(vuln), color = "Conservation Network"))+
    geom_vline(data= atlantic_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = mean(vuln), color = "Bioregion"))+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Atlantic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = "bottom",
          panel.grid.minor.y = element_blank(),
         panel.grid.major.y = element_blank(),
          strip.background = element_rect(fill="white"))

  atlantic_speed <- ggplot(data=atlantic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Atlantic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(size=15),
          axis.title.x = element_text(size=15),
          legend.position = "bottom",
          plot.title = element_text(size=18),
          legend.text = element_text(size=20),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.text = element_text(size = 18),
          strip.background = element_rect(fill="white")) 
  
  pacific_speed <- ggplot(data=pacific_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Pacific Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(size=15),
          axis.title.x = element_text(size=15),
          legend.position = "bottom",
          plot.title = element_text(size=18),
          legend.text = element_text(size=20),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.text = element_text(size = 18),
          strip.background = element_rect(fill="white")) 
  
  #assuring the weighting actually did something
 compare <-  atlantic_plot2 + atlantic_plot
 
 pacific_plot2 <- ggplot(data=pacific_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
   geom_vline(data= pacific_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = mean(vuln), color = "Conservation Network"))+
   geom_vline(data= pacific_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = mean(vuln), color = "Bioregion"))+
   geom_vline(data= pacific_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = mean(vuln), color = "Conservation Network"))+
   geom_vline(data= pacific_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = mean(vuln), color = "Bioregion"))+
   facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Pacific Ocean",fill="")+
   scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
   theme(axis.text.y=element_blank(),
         axis.ticks.y = element_blank(),
         legend.position = "bottom",
         panel.grid.minor.y = element_blank(),
         panel.grid.major.y = element_blank(),
         strip.background = element_rect(fill="white"))
pacific_speed <-  ggplot(data=pacific_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
   facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Pacific Ocean",fill="")+
   scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
   theme(axis.text.y=element_blank(),
         axis.ticks.y = element_blank(),
         axis.text.x = element_text(size=15),
         axis.title.x = element_text(size=15),
         legend.position = "bottom",
         plot.title = element_text(size=18),
         legend.text = element_text(size=20),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.y = element_blank(),
         strip.text = element_text(size = 18),
         strip.background = element_rect(fill="white"))
 
  arctic_plot2 <- ggplot(data=arctic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    geom_vline(data= arctic_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = mean(vuln), color = "Conservation Network"))+
    geom_vline(data= arctic_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = mean(vuln), color = "Bioregion"))+
    geom_vline(data= arctic_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = mean(vuln), color = "Conservation Network"))+
    geom_vline(data= arctic_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = mean(vuln), color = "Bioregion"))+
  facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Arctic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = "bottom",
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.background = element_rect(fill="white"))
  
  artic_speed <- ggplot(data=arctic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Arctic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(size=15),
          axis.title.x = element_text(size=15),
          legend.position = "bottom",
          plot.title = element_text(size=18),
          legend.text = element_text(size=20),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.text = element_text(size = 18),
          strip.background = element_rect(fill="white"))
  
  atlantic_speed <- ggplot(data=atlantic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Atlantic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(size=15),
          axis.title.x = element_text(size=15),
          legend.position = "bottom",
          plot.title = element_text(size=18),
          legend.text = element_text(size=20),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.text = element_text(size = 18),
          strip.background = element_rect(fill="white"))
  
 
 all_oceans_wgt <- pacific_plot2 + theme(axis.text.x = element_blank(),
                                         axis.title.x=element_blank()) + labs(x="") + 
   arctic_plot2 + theme(axis.text.x = element_blank(),
                       axis.title.x=element_blank()) + labs(x="") + 
   plot_annotation(title = "Weighted Ocean Plots")+
   atlantic_plot2 + plot_layout(ncol = 3,guides="collect") &
   theme(legend.position = 'bottom') ; all_oceans_wgt
 
 all_oceans_wgt_2 <- pacific_plot2  + theme(plot.title = element_text(size = 18),axis.text.x = element_text(size = 15))+ labs(x="") + 
   arctic_plot2 + theme(plot.title = element_text(size = 18), axis.text.x = element_text(size = 12)) +labs(x="Vulnerability") + theme(axis.title.x = element_text (size = 18))+
   plot_annotation(title = "Weighted Ocean Plots")+
   atlantic_plot2 + theme(plot.title = element_text(size = 18),axis.text.x = element_text(size = 15))+ labs(x="") + plot_layout(ncol = 3,guides="collect") &
   theme( strip.text = element_text(size = 18),legend.position = 'bottom', legend.text = element_text(size = 18)) ; all_oceans_wgt_2
 
 all_oceans_wgt_2 <- pacific_plot2 + theme(axis.text.x = element_blank(),
                                         axis.title.x=element_blank()) + labs(x="") + 
   arctic_plot2 + theme(axis.text.x = element_blank(),
                        axis.title.x=element_blank()) + labs(x="") + 
   plot_annotation(title = "Weighted Ocean Plots")+
   atlantic_plot2 + plot_layout(nrow=3,guides="collect") &
   theme(legend.position = 'bottom') ; all_oceans_wgt_2
  
 #FIGURE 2
 ggsave("output/wgt_ocean_vulnerability.png",all_oceans_wgt_2,height=8,width=8,units="in",dpi=300)
 
 #means on graph
 #Pacific
 P2.6IN <- pacific_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network")
   mean(P2.6IN$vuln)
   median(P2.6IN$vuln)
 P2.6OUT <- pacific_df%>%filter(rcp=="RCP 2.6", location=="Bioregion")
   mean(P2.6OUT$vuln)
   median(P2.6OUT$vuln)
 P8.5IN <- pacific_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network")
   mean(P8.5IN$vuln)
   median(P8.5IN$vuln)
 P8.5OUT <- pacific_df%>%filter(rcp=="RCP 8.5", location=="Bioregion")
   mean(P8.5OUT$vuln)
   median(P8.5OUT$vuln)
   
 #Atlantic 
 At2.6IN <- atlantic_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network")
   mean(At2.6IN$vuln)
   median(At2.6IN$vuln)
 At2.6OUT <- atlantic_df%>%filter(rcp=="RCP 2.6", location=="Bioregion")
   mean(At2.6OUT$vuln)
   median(At2.6OUT$vuln)
 At8.5IN <- atlantic_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network")
   mean(At8.5IN$vuln)
   median(At8.5IN$vuln)
 At8.5OUT <- atlantic_df%>%filter(rcp=="RCP 8.5", location=="Bioregion")
   mean(At8.5OUT$vuln) 
   median(At8.5OUT$vuln)
   
 #Arctic
 Ar2.6IN <- arctic_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network")
   mean(Ar2.6IN$vuln)
   median(Ar2.6IN$vuln)
 Ar2.6OUT <- arctic_df%>%filter(rcp=="RCP 2.6", location=="Bioregion")
   mean(Ar2.6OUT$vuln)
   median(Ar2.6OUT$vuln)
 Ar8.5IN <- arctic_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network")
   mean(Ar8.5IN$vuln)
   median(Ar8.5IN$vuln)
 Ar8.5OUT <- arctic_df%>%filter(rcp=="RCP 8.5", location=="Bioregion")
   mean(Ar8.5OUT$vuln) 
   median(Ar8.5OUT$vuln)
   
#------BIOREGIONS----------------------------------------------------------------------------------------------------------------
  
  #trying to separate out the bioregions by adjusting the dataframes
  
rcp85_wgt_region_df <- bioregion_df%>% 
                filter(!is.na(adcap),rcp=="RCP 8.5")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),rcp=="RCP 8.5",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))%>%
                data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
                dplyr::select(-geometry)%>% 
                dplyr::left_join(.,region_abbreviations)

rcp26_wgt_region_df <- bioregion_df%>% 
  filter(!is.na(adcap),rcp=="RCP 2.6")%>%
  mutate(location = "Bioregion",
         NAME_E = NA)%>%
  dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
  rbind(.,can_mcn_df%>%
          filter(!is.na(adcap),rcp=="RCP 2.6",location=="inside")%>%
          mutate(location = "Conservation Network")%>%
          dplyr::select(-c(name,Abbreviation,type)))%>%
  data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
  dplyr::select(-geometry)%>%
  dplyr::left_join(.,region_abbreviations)


#density plots
rcp85_wgt_density_region <- ggplot(data=rcp85_wgt_region_df,aes(x=vuln, group=location, fill=location)) +
                            facet_wrap(~region, scale="free_y")+
                             theme(legend.position="bottom") +
                             ggtitle("Bioregions under RCP 8.5") +
                             theme_bw() +
                            geom_density()
                             theme(legend.position="bottom",
                                 panel.spacing = unit(0.1, "lines"),
                                 strip.text.x = element_text(size = 8)) 
                           
 rcp26_wgt_density_region <- ggplot(data=rcp26_wgt_region_df,aes(x=vuln, group=location, fill=location)) +
                               #scale_fill_viridis(discrete = TRUE) +
                               facet_wrap(~region, scale="free_y")+
                               theme(legend.position="bottom") +
                               ggtitle("Bioregions under RCP 2.6") +
                               theme_bw() +
                               geom_density()
                             theme(legend.position="bottom",
                                   panel.spacing = unit(0.1, "lines"),
                                   strip.text.x = element_text(size = 8)) 
                             
#boxplots
  rcp85_wgt_box_region <- ggplot(data=rcp85_wgt_region_df,aes(x=ab_region,y=vuln,fill=location,weight=cell_area))+
    geom_boxplot()+
    theme_bw()+ylab("Vulnerability")+
    labs(x="",y="",title="RCP 8.5",fill="")+
    facet_wrap(.~factor(ocean, levels = ocean_ord), ncol=3,scales="free_y")+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"),
          )+coord_flip()
  
  rcp26_wgt_box_region <- ggplot(data=rcp26_wgt_region_df,aes(x=ab_region,y=vuln,fill=location,weight=cell_area))+
    geom_boxplot()+
    theme_bw()+ylab("Vulnerability")+
    labs(x="",y="Vulnerability",title="RCP 2.6",fill="")+
    facet_wrap(.~factor(ocean, levels = ocean_ord), ncol=3,scales="free_y")+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"),
    )+coord_flip()
  

    
  both_rcp_wgt_box_region <- rcp85_wgt_box_region+ 
                              theme(axis.text.x = element_blank(),axis.title.x=element_blank())+ 
                              labs(x="") + 
                            rcp26_wgt_box_region+ 
                             # theme(axis.text.x = element_blank(), axis.title.x=element_blank()) + 
                              labs("") + 
                               plot_annotation(title = "Bioregional Vulnerability")+
                               plot_layout(nrow = 2,ncol = 1, guides = "collect")&
                              theme(legend.position = 'bottom')
  
 
   #95% CIs-----------------------------------------------------
  #### MY CODE
  options(max.print = .Machine$integer.max) #set print limit to machine's limit
  
 #applying to individual plots
  location_out <- c("outside")
  location_in <- c("inside")
  bioregions <- c("Western Arctic", "Gulf of Saint Lawrence", "Newfoundland-Labrador Shelves", "Offshore Pacific", "Scotian Shelf", "Northern Shelf", "Arctic Basin", "Strait of Georgia", "Eastern Arctic")
  
  require(plyr)
  df <- data.frame() #create an empty dataframe to add results of each iteration of your loop to
  for(i in bioregions){   ##start of the loop which means do this for all of the bioregions
    
    message(paste0("Working on ",i))                 ##will show what is being done when
    
    m <-  can_mcn_extracts%>%filter(region==i)%>% select(c(vuln,location,rcp,region))%>% # for each bioregion, make a new dataframe without NAs
      data.frame(x = .$vuln, y = .$location, rcp = as.character(.$rcp))%>% #set these as the variables
      na.omit() #assure the function below works by removing NAs
    
    for (l in location_out)
    {
      q <- m%>% filter(rcp=="2.6",y==l)
      f <- function(x){data.frame(v.mean = mean(q$vuln), v.upr = mean(q$vuln)+1.96*(sd(q$vuln)/sqrt(length(q$vuln))), v.lwr = mean(q$vuln)-1.96*(sd(q$vuln)/sqrt(length(q$vuln))))} 
      rcp26 <- ddply(q,.(y,rcp),f)
      
      q <- m%>% filter(rcp=="8.5",y==l)
      rcp85<- ddply(q,.(y,rcp),f)
      
    }
    outside_CIs <- rbind(rcp85,rcp26)
    
    
    for (l in location_in)
    {
      q <- m%>% filter(rcp=="2.6",y==l)
      f <- function(x){data.frame(v.mean = mean(q$vuln), v.upr = mean(q$vuln)+1.96*(sd(q$vuln)/sqrt(length(q$vuln))), v.lwr = mean(q$vuln)-1.96*(sd(q$vuln)/sqrt(length(q$vuln))))} 
      rcp26 <- ddply(q,.(y,rcp),f)
      
      q <- m%>% filter(rcp=="8.5",y==l)
      rcp85<- ddply(q,.(y,rcp),f)
      
    }
    inside_CIs <- rbind(rcp85,rcp26)
    
    all_scenarios<- rbind(outside_CIs,inside_CIs)
    all_scenarios$region<-i
    df <- rbind(df, all_scenarios)  # Using rbind() to append the output of one iteration to the dataframe
      } #kind of clunky but it runs!

  ### PLOTTING ----------------------------------------------------------
  plots <- list()
  library(cowplot)
  for (j in unique(df$region)){
    plot_df <- df[df$region == j, ]
    
    p1 <- ggplot(plot_df, aes(x = y, y = v.mean, group=as.factor(rcp), color=as.factor(rcp)))+
      geom_errorbar(aes(ymin=v.lwr, ymax=v.upr), width=0.6, size=0.5, position=position_dodge(0.3)) +
      geom_point(position=position_dodge(0.3), shape=21, size=2, fill="white")+ 
      labs(title = j, x= "Location", y = "Vulnerability")
    
    p_out <- plot_grid(p1, align = "v", ncol = 1, rel_heights = c(.7, .3))
    
    plots[[j]] <- p_out
    
  }
  require(gridExtra)
  do.call(grid.arrange, plots)
  
  
  #FOR A SINGLE REGION  
  Western_Arctic_df <- can_mcn_extracts %>% filter(region == "Western Arctic")%>%
    select(c(vuln,region,location,rcp))%>%
    data.frame(x = .$vuln, y = .$location, rcp = as.character(.$rcp))%>% #set these as the variables
    na.omit()
  
  q <- Western_Arctic_df%>% filter(rcp=="2.6",y=="inside")
  f <- function(x){data.frame(v.mean = mean(q$vuln), v.upr = mean(q$vuln)+1.96*(sd(q$vuln)/sqrt(length(q$vuln))), v.lwr = mean(q$vuln)-1.96*(sd(q$vuln)/sqrt(length(q$vuln))))} 
  in26 <- plyr::ddply(q,.(y,rcp),f);print(in26)
  
  q <- Western_Arctic_df%>% filter(rcp=="2.6",y=="outside")
  out26<- plyr::ddply(q,.(y,rcp),f);print(out26)
  
  q <- Western_Arctic_df%>% filter(rcp=="8.5",y=="inside")
  in85 <- plyr::ddply(q,.(y,rcp),f);print(in85)
  
  q <- Western_Arctic_df%>% filter(rcp=="8.5",y=="outside")
  out85<- plyr::ddply(q,.(y,rcp),f);print(out85)
  
  rcp26 <- rbind(in26,out26)
  rcp85 <- rbind(in85,out85)
  all_WA_rcps <- rbind(rcp26,rcp85);all_WA_rcps
  
  Western_Arctic_plot <- ggplot(all_WA_rcps, aes(x=y, y=v.mean, group=as.factor(rcp)))+
    labs(title = "Western Arctic",x = "Location", y="Vulnerability")+
    geom_errorbar(aes(ymin=v.lwr, ymax=v.upr), width=0.6, size=0.5, position=pd) +
    geom_point(position=pd, shape=21, size=1, fill="white"); Western_Arctic_plot #it works for a single plot 
  
#trying to fix the fact that all values come out the same...
  
  q <- CI_df%>% filter(rcp=="2.6",y=="inside")
  f <- function(x){data.frame(v.mean = mean(q$vuln), v.upr = mean(q$vuln)+1.96*(sd(q$vuln)/sqrt(length(q$vuln))), v.lwr = mean(q$vuln)-1.96*(sd(q$vuln)/sqrt(length(q$vuln))))} 
  in26 <- plyr::ddply(q,.(y,rcp),f);print(in26)
 
  q <- CI_df%>% filter(rcp=="2.6",y=="outside")
  out26<- plyr::ddply(q,.(y,rcp),f);print(out26)
  
  q <- CI_df%>% filter(rcp=="8.5",y=="inside")
  in85 <- ddply(q,.(y,rcp),f);print(in85)
  
  q <- CI_df%>% filter(rcp=="8.5",y=="outside")
  out85<- ddply(q,.(y,rcp),f);print(out85)
  
  rcp26 <- rbind(in26,out26)
  rcp85 <- rbind(in85,out85)
  all_rcps <- rbind(rcp26,rcp85);all_rcps
  
  all_bioregions <- ggplot(all_rcps, aes(x=y, y=v.mean, group=as.factor(rcp)))+
    labs(title = "All Biorgeions",x="Location",y="Vulnerability")+
    geom_errorbar(aes(ymin=v.lwr, ymax=v.upr), width=0.6, size=0.5, position=pd) +
    geom_point(position=pd, shape=21, size=1, fill="white"); all_bioregions # this works for all bioregions combined
  
#####CHRISTINES CODE
### So if x=vulnerability, and y=inside or outside, and we have a mix of RCPs, lets create a fake example dataset:
xy<-data.frame(vuln=c(0.33,0.34,0.32,0.55,0.65,0.61,0.38, 0.66,0.77,0.78,0.98,0.99,0.56,0.67),y=c("inside", "inside","inside","inside","inside","inside","inside", "outside", "outside","outside","outside","outside","outside","outside"), rcp=as.character(c(2.6,8.5, 2.6,8.5, 2.6,8.5, 2.6,8.5, 2.6,8.5, 2.6,8.5, 2.6,8.5)))

### take a look:
head(xy)
str(xy)  #this shows you that I defined the RCPs as a character variable so that R doesn’t think this is a continuous variable

### Calculate mean and upper and lower bounds of your 95% CI’s (calculated as the mean + and – the standard error) for inside, outside, and both rcps separately using ddply (i.e., applying the function, fn, to each unique instance in column y and column rcp):
fn<-function(x){data.frame(v.mean=mean(x$vuln), v.upr=mean(x$vuln)+1.96*(sd(x$vuln)/sqrt(length(x$vuln))), v.lwr= mean(x$vuln)-1.96*(sd(x$vuln)/sqrt(length(x$vuln))))}
toplot<-plyr::ddply(xy,.(y,rcp),fn)

### take a look:
toplot

### Now plot with the errorbars defined by the CI bounds you calculated above:
pd <- position_dodge(0.3)
ggplot(toplot, aes(x=y, y=v.mean, group=as.factor(rcp)))+
  geom_errorbar(aes(ymin=v.lwr, ymax=v.upr), width=0.6, size=0.5, position=pd) +
  geom_point(position=pd, shape=21, size=1, fill="white")

### You could manually make the error bars thicker and the points larger (type ?geom_errorbar and ?geom_point into your console to see how to change width and size) where there appears to be a significant difference. In this example, the different between inside vs outside is not statistically significant for either of the RCPs, even though the mean vuln outside is almost twice the mean vuln inside. The difference is most prominent under RCP 2.6. (just giving you an example of how you can write about these types of results in your thesis)..

   #FIGURE 3
  ggsave("output/both_rcp_wgt_box_region.png",both_rcp_wgt_box_region,height=6,width=12,units="in",dpi=300)
  
  
  #trying to use plotting orders
  rcp85_wgt_region_df%>%
    mutate(ocean=factor(ocean,levels=bioregion_ord))%>%
  ggplot(.,aes(x=ab_region,y=vuln,fill=location,weight=cell_area))+
    geom_boxplot()+
    theme_bw()+ylab("Vulnerability")+
    labs(x="",y="Vulnerability",title="RCP 8.5",fill="")+
   #facet_wrap(~ocean, scales ="free_y")+
    #facet_wrap(factor(bioregions, levels = bioregion_ord))+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"),
    )+coord_flip()

  
 test8.5 <- rcp85_wgt_region_df%>%
            mutate(location = "Conservation Network",
                   name=factor(NAME_E,levels=mpa_ord),
                   region=factor(region,levels=bioregion_ord),
                   ocean=factor(ocean,levels=ocean_ord),
                   rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                   rcp=factor(rcp,levels=rcp_ord))%>%
    data.frame()%>% 
    dplyr::left_join(.,region_abbreviations)
 
     
#--------DRAFT NETWORK----------------------------------------------------------------------------------------------------------------
     #FIGURE 4
     netp <- ggplot(data=mar_network_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
       geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
       facet_grid(rcp~.)+
       theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
       coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
       labs(x="Vulnerability",y="",title="Scotian Shelf-Bay of Fundy Draft Network",fill="")+
   scale_fill_discrete(labels = c("Outside Draft Network","Within Draft Network"))+
   theme(axis.text.y = element_blank(),
         axis.ticks.y = element_blank(),
         legend.position = "bottom", legend.title = element_blank(),
         strip.background = element_rect(fill="white"))

 speed_mar_plot <- ggplot(data=mar_network_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
   facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Scotian Shelf-Bay of Fundy Draft Network",fill="")+
   scale_fill_discrete(labels = c("Outside Draft Network","Within Draft Network"))+
   theme(axis.text.y=element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.x = element_text(size=15),
           axis.title.x = element_text(size=15),
           legend.position = "bottom",
           plot.title = element_text(size=18),
           legend.text = element_text(size=20),
           panel.grid.minor.y = element_blank(),
           panel.grid.major.y = element_blank(),
           strip.text = element_text(size = 18),
           strip.background = element_rect(fill="white"))
     
     
     wgt_box_network <- ggplot(data=mar_network_df,aes(x=location,y=vuln,fill=rcp, weight=cell_area))+
       geom_boxplot()+ggtitle("Scotian Shelf-Bay of Fundy Draft Network")+
       theme_bw()+ylab("Vulnerability")+
       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
             legend.position = "bottom", legend.title = element_blank(),
             strip.background = element_rect(fill="white"))
     
     wgt_box_within_types <- ggplot(data=mar_network_df,aes(x=mar_type,y=vuln,fill = rcp, weight=cell_area))+
       geom_boxplot()+ggtitle("Scotian Shelf-Bay of Fundy Draft Network")+
       theme_bw()+ylab("Vulnerability")+
       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
             legend.position = "bottom", legend.title = element_blank(),
             strip.background = element_rect(fill="white"))

     wgt_box_network_sites_without_planning_area <-
       mar_network_df %>%
       filter(!is.na(abbreviation)) %>%
      ggplot(aes(x=abbreviation,y=vuln,fill = rcp, weight=cell_area))+
       geom_boxplot(na.rm=TRUE)+ggtitle("Scotian Shelf-Bay of Fundy Draft Network")+
       theme_bw()+ylab("Vulnerability")+
       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
             legend.position = "bottom", axis.title.x = element_blank(),legend.title = element_blank(),
             strip.background = element_rect(fill="white"))
       
     
#------------DEPTH--------------------------------------------------------------------------------------------------------------
   
     max_depth <- round_any(min(can_mcn_df$bathy,na.rm=TRUE)*-1,100)
     
     breaks_simple <- c(0,50,100,250,500,max_depth)
     
     breaks_simple_df <- data.frame(lower=breaks_simple[1:(length(breaks_simple)-1)],
                                    upper=breaks_simple[2:length(breaks_simple)])%>%
       dplyr::mutate(label=paste0(lower,"-",upper," m"),
              interval=0:(n()-1))
     
     depth_comp <- rbind(atlantic_df,pacific_df,arctic_df)%>%
       data.frame()%>%
       dplyr::select(-geometry)%>%
       filter(!is.na(bathy))%>%
       mutate(depth=bathy*-1,
              interval = findInterval(depth,breaks_simple[2:length(breaks_simple)]))%>%
       left_join(breaks_simple_df)%>%
       group_by(ocean,location,label)%>%
       dplyr::summarise(area=sum(cell_area))%>%
       ungroup()%>%
       group_by(ocean,location)%>%
       mutate(prop_area=area/sum(area))%>%
       ungroup()%>%
       mutate(location=ifelse(location=="Conservation Network","Network",location))%>%
       dplyr::select(-area)%>%
       spread(location,prop_area)%>%
       left_join(breaks_simple_df)%>%
       mutate(Network = ifelse(is.na(Network),0,Network), #depths aren't within that range
              Bioregion = ifelse(is.na(Bioregion),0,Bioregion),
              differential=Network-Bioregion,
              depth=upper*-1,
              label=factor(label,levels=rev(breaks_simple_df%>%pull(label))))
     
     depth_prop_comp <- ggplot()+
       geom_point(data=depth_comp,aes(x=label,y=differential,col=differential),size=3)+
       geom_hline(yintercept=0)+
       geom_vline(xintercept=shelf_break*-1,lty=2)+
       geom_segment(data=depth_comp,aes(x=label,xend=label,y=0,yend=differential,col=differential),lwd=1)+
       theme_bw()+
       facet_wrap(~ocean)+
       scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
       scale_color_viridis_c(option="C")+
       coord_flip()+
       labs(y="Proportional differential",x="",col="")+
       theme(legend.position = "none",
             strip.background = element_rect(colour = "black", fill = "white"),
             strip.text.x = element_text(colour = "black"),
             axis.text.y = element_text(colour = "black"),
             axis.text.x = element_text(colour = "black",size=8))
     
     ggsave("output/depth_prop_comp.png",depth_prop_comp,width=6,height=6,units="in",dpi=300)
     
     
    depth_bar <-rbind(atlantic_df,pacific_df,arctic_df)%>%
                data.frame()%>%
                dplyr::select(-geometry)%>%
                filter(!is.na(bathy))%>%
                mutate(depth=bathy*-1,
                       interval = findInterval(depth,breaks_simple[2:length(breaks_simple)]))%>%
                left_join(breaks_simple_df)%>%
                group_by(ocean,location,label)%>%
                dplyr::summarise(area=sum(cell_area))%>%
                ungroup()%>%
                group_by(ocean,location)%>%
                mutate(prop_area = area/sum(area))%>%
                ungroup()%>%
                data.frame()%>%
                mutate(label=factor(label,levels=rev(breaks_simple_df%>%pull(label))),
                       ocean=factor(ocean,levels=c("Pacific","Arctic","Atlantic")))
    
    depth_barplot <- ggplot(depth_bar%>%filter(location=="Conservation Network"))+
                    geom_bar(aes(x=label,y=prop_area,fill=label),stat="identity",col="black")+
                    facet_wrap(~ocean,ncol=3)+
                    labs(y="% area within network",x="")+
                    scale_y_continuous(labels = percent_format)+
                  # scale_y_continuous(labels = scales::percent_format(accuracy = 1, scale = 1))+
                    coord_flip()+
                    scale_fill_viridis(discrete=T)+
                    theme_bw()+
                    theme(legend.position = "none",
                          strip.background = element_rect(colour = "black", fill = "white"),
                          strip.text.x = element_text(colour = "black"),
                          axis.text.y = element_text(colour = "black"),
                          axis.text.x = element_text(colour = "black",size=8));depth_barplot
    
    
    ggsave("output/depth_aggbar_comp.png",depth_barplot,width=8,height=6,units="in",dpi=300)
    
     

keep <- c("MPA", "OECM")

full_depth_summary <- can_mcn_df%>%
                      select(bathy:cell_area)%>% 
                      filter(type %in% keep)%>% 
                      group_by(NAME_E)%>%
                      summarize(mean_depth = mean(bathy, na.rm = TRUE),
                       max_depth = min(bathy))


test <- can_mcn_df%>%
        select(bathy:cell_area)

full_depth_summary <- test%>%
                      filter(type %in% keep)%>% 
                      group_by(NAME_E)%>%
                      summarize(mean_depth = mean(bathy, na.rm = TRUE),
                                max_depth = min(bathy))

mpa_oecm_depths <- ggplot(full_depth_summary, aes(x=max_depth)) + 
              xlim(-5500,-20)+ #excluding extremely shallow depths to see if that gives me a better outcome, but don't really think this is the answer to the issue
              ylim(0,8)+
              geom_histogram(bins = 6)+
              labs(x="Bathymetry (in m)", y="Number of MPAs/OECMs",
                   title="Max MPA & OECM Depths")

#this graph technically looks better I guess?? but this is after lots of manipulation so it seems wrong


#code for only MPAs 
MPA_depth_summary <- can_mcn_df%>%
                    filter(type == "MPA")%>%
                    group_by(NAME_E)%>%
                    summarize(mean_depth = mean(bathy, na.rm = TRUE),
                              max_depth = min(bathy))

                    
     #MPA plot
ggplot(MPA_depth_summary, aes(x=max_depth)) + 
     geom_histogram()+
     labs(x="Bathymetry", 
          title="Max MPA Depths")
                  
#FIGURE 5   
  bathy_vuln_initial <- ggplot(can_mcn_df, aes(x=bathy, y=vuln)) + 
       geom_point(aes(col=bathy)) +
       geom_smooth(method="loess", se=F) + theme_bw()+
       labs(y="Vulnerability", 
            x="Bathymetry (in m)", 
            title="Depth Vs Vulnerability")
  
  
  
  library(ggalt)
  library(ggpubr)
  library(ggExtra)
  library(ggcorrplot)
  
  m <- ggplot(can_mcn_df, aes(x=bathy, y=vuln)) + 
    geom_count() + 
    geom_smooth(method="lm", se=F); m
  
  ggMarginal(m, type = "histogram", fill="transparent")
  ggMarginal(m, type = "boxplot", fill="transparent")
  
 
  data(can_mcn_df)
  corr <- round(cor(can_mcn_df), 1)
  ggcorrplot(corr, hc.order = TRUE, 
             type = "lower", 
             lab = TRUE, 
             lab_size = 3, 
             method="circle", 
             colors = c("tomato2", "white", "blue3"), 
             title="Correlogram of depth and vulnerability", 
             ggtheme=theme_bw)
  
  j <- can_mcn_df%>% 
    filter(location=="inside")%>%
    data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
    dplyr::select(-geometry)
    
    q <- ggplot(j, aes(x=bathy, y=vuln, color=vuln, size=bathy)) +
    geom_point() + 
      #xlim(-1000,0)+
    theme(legend.position="bottom")
  
  # with marginal histogram
  p2 <- ggMarginal(q, type="histogram");p2
  
  
  
so_far <- depth_comp%>%
    dplyr::select(-geometry)%>%
    filter(!is.na(bathy))%>%
    mutate(depth=bathy*-1,
           interval = findInterval(depth,breaks_simple[2:length(breaks_simple)]))%>%
    left_join(breaks_simple_df)%>%
  
  second <- so_far%>%
    group_by(ocean,location,label)%>%
    summarise(area=sum(cell_area))%>%
    ungroup()%>%
  
  second%>%
    group_by(ocean,location)%>%
    mutate(prop_area=area/sum(area))%>%
    ungroup()%>%
    mutate(location=ifelse(location=="Conservation Network","Network",location))%>%
    dplyr::select(-area)%>%
    spread(location,prop_area)%>%
    left_join(breaks_simple_df)%>%
    mutate(Network = ifelse(is.na(Network),0,Network), #depths aren't within that range
           Bioregion = ifelse(is.na(Bioregion),0,Bioregion),
           differential=Network-Bioregion,
           depth=upper*-1,
           label=factor(label,levels=rev(breaks_simple_df%>%pull(label))))
  
  
