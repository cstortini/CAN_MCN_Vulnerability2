#loading in the necessary libraries -------
library(dplyr)
library(ggplot2)
library(patchwork)
library(ggridges)
library(sf)
library(patchwork)
library(gghalves)
library(patchwork)
library(rnaturalearth)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
  latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
  CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

##load data from the overlay analysis - 02_overlay_analysis.R ----
  load("output/bioregion_extract.RData") #extracts of the entire bioregions
  load("output/can_network_extract.RData") #extracts from the Canadian Marine Conservation Network - inside and outside within each bioregion
  load("output/mar_network_extract.RData") #extracts from the Scotian Shelf-Bay of Fundy Draft Network - inside and outside the Maritimes region

#load polygons ----- 
  #using the polygon_load function - this load polygons for each function instead of re-writing the code multiple times. Makes things more consistent. 
  source("code/polygon_load.R")
  polygon_load()
  
#Plotting levels ----
      ocean_ord <- c("Pacific","Arctic","Atlantic")
      rcp_ord <- c("RCP 8.5","RCP 2.6")
      
      can_bioregions_centroids <- can_bioregions%>%
        st_centroid()%>%
        st_transform(latlong)%>%
        mutate(lat = st_coordinates(.)[,2],
               ocean = factor(ocean,levels=ocean_ord))%>%
        data.frame()%>%
        arrange(ocean,lat) #arrange them by latitude (centroid) within each bioregion
      
      bioregion_ord <- can_bioregions_centroids%>%pull(region)
      
      mpa_ord <- can_mcn_regions%>%
                           mutate(region=factor(region,levels=bioregion_ord))%>%
                           arrange(region,clat)%>%pull(NAME_E) #arrange them by latitude (centroid) within each bioregion
    
    #Load plotting abbreviations and set levels for the plotting dataframes
      mpa_abbreviations <- read.csv("data/mpa_abbreviations.csv")
      region_abbreviations <- read.csv("data/region_abbreviations.csv")
      mcn_abbreviations <- read.csv("data/mcn_abbreviations.csv") #these are ones that I made up quickly for every type of closure in the Canadian MCN
      mar_abbreviations <- read.csv("data/mar_draft_network_abbreviations.csv")%>%arrange(group,lat) #these are the ones used by Lewis et al. arraged by group and latitute 
      
    #merge in the abbreviations with the extracts and set plotting levels
      bioregion_df <- bioregion_extract%>%
                      left_join(.,region_abbreviations)%>%
                      mutate(region=factor(region,levels=bioregion_ord),
                             rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                             rcp=factor(rcp,levels=rcp_ord)) 
      
      can_mcn_df <- can_mcn_extracts%>%
                    left_join(.,mcn_abbreviations)%>%
                    mutate(name=factor(NAME_E,levels=mpa_ord),
                           region=factor(region,levels=bioregion_ord),
                           ocean=factor(ocean,levels=ocean_ord),
                           rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                           rcp=factor(rcp,levels=rcp_ord))
      
      mar_network_df <- mar_network_extract%>%
                        left_join(.,mar_abbreviations%>%dplyr::select(-c(long,lat)))%>%
                        mutate(name = factor(mar_name,levels = mar_abbreviations%>%pull(abbreviation)),
                               rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                               rcp=factor(rcp,levels=rcp_ord)) 
  
  
#---------------OCEAN -------------------------------------------------------------------------------------------------------------
 ## Ridge plots ----- ** note that the ridge plots don't currently do weighted ridgelines, but there seem to be some work arounds that maybe you can try (https://github.com/wilkelab/ggridges/issues/5)
  #data.frames that have all the values for the region and then for the site. Note that we can't use the cell_area to weight these values so the plots can be sort of misleading
  atlantic_df <- bioregion_df%>% 
                 filter(!is.na(adcap),ocean=="Atlantic")%>%
                 mutate(location = "Bioregion",
                        NAME_E = NA)%>%
                 dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                 rbind(.,can_mcn_df%>%
                         filter(!is.na(adcap),ocean=="Atlantic",location=="inside")%>%
                         mutate(location = "Conservation Network")%>%
                         dplyr::select(-c(name,Abbreviation,type)))
  
  pacific_df <- bioregion_df%>% 
                filter(!is.na(adcap),ocean=="Pacific")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),ocean=="Pacific",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))
  
  arctic_df <- bioregion_df%>% 
                filter(!is.na(adcap),ocean=="Arctic")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),ocean=="Arctic",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))
  
  # oceans plots with weighting
  
  atlantic_plot2 <- ggplot(data=atlantic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Atlantic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = "bottom",
          panel.grid.minor.y = element_blank(),
         panel.grid.major.y = element_blank(),
          strip.background = element_rect(fill="white"))
  
  #assuring the weighting actually did something
 compare <-  atlantic_plot2 + atlantic_plot
 
 pacific_plot2 <- ggplot(data=pacific_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
   facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Pacific Ocean",fill="")+
   scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
   theme(axis.text.y=element_blank(),
         axis.ticks.y = element_blank(),
         legend.position = "bottom",
         panel.grid.minor.y = element_blank(),
         panel.grid.major.y = element_blank(),
         strip.background = element_rect(fill="white"))
 
  arctic_plot2 <- ggplot(data=arctic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
   facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Arctic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = "bottom",
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.background = element_rect(fill="white"))
 
 all_oceans_wgt <- pacific_plot2 + theme(axis.text.x = element_blank(),
                                         axis.title.x=element_blank()) + labs(x="") + 
   arctic_plot2 + theme(axis.text.x = element_blank(),
                       axis.title.x=element_blank()) + labs(x="") + 
   plot_annotation(title = "Weighted Ocean Plots")+
   atlantic_plot2 + plot_layout(nrow=3,guides="collect") &
   theme(legend.position = 'bottom') ; all_oceans_wgt
 
 all_oceans_wgt_2 <- pacific_plot2 + theme(axis.text.x = element_blank(),
                                         axis.title.x=element_blank()) + labs(x="") + 
   arctic_plot2 + theme(axis.text.x = element_blank(),
                        axis.title.x=element_blank()) + labs(x="") + 
   plot_annotation(title = "Weighted Ocean Plots")+
   atlantic_plot2 + plot_layout(ncol=3,guides="collect") &
   theme(legend.position = 'bottom') ; all_oceans_wgt_2
  
 #FIGURE 2
 ggsave("output/wgt_ocean_vulnerability.png",all_oceans_wgt,height=8,width=6,units="in",dpi=300)
 
 
#------BIOREGIONS----------------------------------------------------------------------------------------------------------------
  
  #trying to separate out the bioregions by adjusting the dataframes
  
rcp85_wgt_region_df <- bioregion_df%>% 
                filter(!is.na(adcap),rcp=="RCP 8.5")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),rcp=="RCP 8.5",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))%>%
                data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
                dplyr::select(-geometry)%>% 
                dplyr::left_join(.,region_abbreviations)

rcp26_wgt_region_df <- bioregion_df%>% 
  filter(!is.na(adcap),rcp=="RCP 2.6")%>%
  mutate(location = "Bioregion",
         NAME_E = NA)%>%
  dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
  rbind(.,can_mcn_df%>%
          filter(!is.na(adcap),rcp=="RCP 2.6",location=="inside")%>%
          mutate(location = "Conservation Network")%>%
          dplyr::select(-c(name,Abbreviation,type)))%>%
  data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
  dplyr::select(-geometry)%>%
  dplyr::left_join(.,region_abbreviations)


#density plots
rcp85_wgt_density_region <- ggplot(data=rcp85_wgt_region_df,aes(x=vuln, group=location, fill=location)) +
                            facet_wrap(~region, scale="free_y")+
                             theme(legend.position="bottom") +
                             ggtitle("Bioregions under RCP 8.5") +
                             theme_bw() +
                            geom_density()
                             theme(legend.position="bottom",
                                 panel.spacing = unit(0.1, "lines"),
                                 strip.text.x = element_text(size = 8)) 
                           
 rcp26_wgt_density_region <- ggplot(data=rcp26_wgt_region_df,aes(x=vuln, group=location, fill=location)) +
                               #scale_fill_viridis(discrete = TRUE) +
                               facet_wrap(~region, scale="free_y")+
                               theme(legend.position="bottom") +
                               ggtitle("Bioregions under RCP 2.6") +
                               theme_bw() +
                               geom_density()
                             theme(legend.position="bottom",
                                   panel.spacing = unit(0.1, "lines"),
                                   strip.text.x = element_text(size = 8)) 
                             
#boxplots
  rcp85_wgt_box_region <- ggplot(data=rcp85_wgt_region_df,aes(x=ab_region,y=vuln,fill=location,weight=cell_area))+
    geom_boxplot()+
    theme_bw()+ylab("Vulnerability")+
    labs(x="",y="",title="RCP 8.5",fill="")+
    facet_wrap(.~factor(ocean, levels = ocean_ord), ncol=3,scales="free_y")+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"),
          )+coord_flip()
  
  rcp26_wgt_box_region <- ggplot(data=rcp26_wgt_region_df,aes(x=ab_region,y=vuln,fill=location,weight=cell_area))+
    geom_boxplot()+
    theme_bw()+ylab("Vulnerability")+
    labs(x="",y="Vulnerability",title="RCP 2.6",fill="")+
    facet_wrap(.~factor(ocean, levels = ocean_ord), ncol=3,scales="free_y")+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"),
    )+coord_flip()
  

    
  both_rcp_wgt_box_region <- rcp85_wgt_box_region+ 
                              theme(axis.text.x = element_blank(),axis.title.x=element_blank())+ 
                              labs(x="") + 
                            rcp26_wgt_box_region+ 
                             # theme(axis.text.x = element_blank(), axis.title.x=element_blank()) + 
                              labs("") + 
                               plot_annotation(title = "Bioregional Vulnerability")+
                               plot_layout(nrow = 2,ncol = 1, guides = "collect")&
                              theme(legend.position = 'bottom')
  
  #FIGURE 3
  ggsave("output/both_rcp_wgt_box_region.png",both_rcp_wgt_box_region,height=6,width=12,units="in",dpi=300)
  
  
  #trying to use plotting orders
  rcp85_wgt_region_df%>%
    mutate(ocean=factor(ocean,levels=bioregion_ord))%>%
  ggplot(.,aes(x=ab_region,y=vuln,fill=location,weight=cell_area))+
    geom_boxplot()+
    theme_bw()+ylab("Vulnerability")+
    labs(x="",y="Vulnerability",title="RCP 8.5",fill="")+
   #facet_wrap(~ocean, scales ="free_y")+
    #facet_wrap(factor(bioregions, levels = bioregion_ord))+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"),
    )+coord_flip()

  
 test8.5 <- rcp85_wgt_region_df%>%
            mutate(location = "Conservation Network",
                   name=factor(NAME_E,levels=mpa_ord),
                   region=factor(region,levels=bioregion_ord),
                   ocean=factor(ocean,levels=ocean_ord),
                   rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                   rcp=factor(rcp,levels=rcp_ord))%>%
    data.frame()%>% 
    dplyr::left_join(.,region_abbreviations)
 
     
#--------DRAFT NETWORK----------------------------------------------------------------------------------------------------------------
     #FIGURE 4
     netp <- ggplot(data=mar_network_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
       geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
       facet_grid(rcp~.)+
       theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
       coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
       labs(x="Vulnerability",y="",title="Scotian Shelf-Bay of Fundy Draft Network",fill="")+
       theme(axis.text.y=element_blank(),
             legend.position = "bottom",
             strip.background = element_rect(fill="white"),
             axis.ticks.y = element_blank())
     
     
     
     
     wgt_box_network <- ggplot(data=mar_network_df,aes(x=location,y=vuln,fill=rcp, weight=cell_area))+
       geom_boxplot()+ggtitle("Scotian Shelf-Bay of Fundy Draft Network")+
       theme_bw()+ylab("Vulnerability")+
       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
             legend.position = "bottom", legend.title = element_blank(),
             strip.background = element_rect(fill="white"))
     
     wgt_box_within_types <- ggplot(data=mar_network_df,aes(x=mar_type,y=vuln,fill = rcp, weight=cell_area))+
       geom_boxplot()+ggtitle("Scotian Shelf-Bay of Fundy Draft Network")+
       theme_bw()+ylab("Vulnerability")+
       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
             legend.position = "bottom", legend.title = element_blank(),
             strip.background = element_rect(fill="white"))

     wgt_box_network_sites_without_planning_area <-
       mar_network_df %>%
       filter(!is.na(abbreviation)) %>%
      ggplot(aes(x=abbreviation,y=vuln,fill = rcp, weight=cell_area))+
       geom_boxplot(na.rm=TRUE)+ggtitle("Scotian Shelf-Bay of Fundy Draft Network")+
       theme_bw()+ylab("Vulnerability")+
       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
             legend.position = "bottom", axis.title.x = element_blank(),legend.title = element_blank(),
             strip.background = element_rect(fill="white"))
       
     
#------------DEPTH--------------------------------------------------------------------------------------------------------------
   
  sf_use_s2(FALSE) #this is to prevent an edge error when making the summary table

keep <- c("MPA", "OECM")

full_depth_summary <- can_mcn_df%>%
                      filter( type %in% keep)%>% 
                      group_by(NAME_E)%>%
                      summarize(mean_depth = mean(bathy, na.rm = TRUE),
                       max_depth = min(bathy))

mpa_oecm_depths <- ggplot(full_depth_summary, aes(x=max_depth)) + 
              geom_histogram()+
              labs(x="Bathymetry", 
                   title="Max MPA & OECM Depths")


#code for only MPAs 
MPA_depth_summary <- can_mcn_df%>%
                    filter(type == "MPA")%>%
                    group_by(NAME_E)%>%
                    summarize(mean_depth = mean(bathy, na.rm = TRUE),
                              max_depth = min(bathy))

                    
     #MPA plot
ggplot(MPA_depth_summary, aes(x=max_depth)) + 
     geom_histogram()+
     labs(x="Bathymetry", 
          title="Max MPA Depths")
                  
#FIGURE 5   
  bathy_vuln_initial <- ggplot(can_mcn_df, aes(x=bathy, y=vuln)) + 
       geom_point(aes(col=bathy)) +
       geom_smooth(method="loess", se=F) + theme_bw()+
       labs(y="Vulnerability", 
            x="Bathymetry", 
            title="Depth Vs Vulnerability")
  
  
  
  library(ggalt)
  library(ggpubr)
  library(ggExtra)
  library(ggcorrplot)
  
  m <- ggplot(can_mcn_df, aes(x=bathy, y=vuln)) + 
    geom_count() + 
    geom_smooth(method="lm", se=F); m
  
  ggMarginal(m, type = "histogram", fill="transparent")
  ggMarginal(m, type = "boxplot", fill="transparent")
  
 
  data(can_mcn_df)
  corr <- round(cor(can_mcn_df), 1)
  ggcorrplot(corr, hc.order = TRUE, 
             type = "lower", 
             lab = TRUE, 
             lab_size = 3, 
             method="circle", 
             colors = c("tomato2", "white", "blue3"), 
             title="Correlogram of depth and vulnerability", 
             ggtheme=theme_bw)
  
  j <- can_mcn_df%>% 
    filter(location=="inside")%>%
    data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
    dplyr::select(-geometry)
    
    q <- ggplot(j, aes(x=bathy, y=vuln, color=vuln, size=bathy)) +
    geom_point() + 
      #xlim(-1000,0)+
    theme(legend.position="bottom")
  
  # with marginal histogram
  p2 <- ggMarginal(q, type="histogram");p2
