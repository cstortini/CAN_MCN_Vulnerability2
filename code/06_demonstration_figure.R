## load libraries and functions
library(dplyr)
library(sf)
library(rnaturalearth)
library(ggplot2)
library(stars)
library(raster)
library(viridis)
library(pals)
source("code/polygon_load.R")

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

#load poygons
polygon_load()

##load example species data "Atlantic cod"      "Atlantic mackerel" "American lobster" 
load("data/Vuln_ExampleSpp.rda")

#quick summary of the ranges
dat%>%
  group_by(spname)%>%
  summarise(sens_range = paste(round(min(sens,na.rm=T),2),round(max(sens,na.rm=T),2),sep="-"),
            expo_range = paste(round(min(expo,na.rm=T),2),round(max(expo,na.rm=T),2),sep="-"),
            adcap_range = paste(round(min(adcap,na.rm=T),2),round(max(adcap,na.rm=T),2),sep="-"),
            vuln_range = paste(round(min(vuln,na.rm=T),2),round(max(vuln,na.rm=T),2),sep="-"))
ungroup()%>%
  data.frame()

##plotting parameters
plot_box <- dat%>%
            filter(spname=="Gadus morhua")%>%
            st_as_sf(coords = c("lon","lat"),crs=latlong)%>%
            st_bbox()

plot_box[c(1,3)] <- c(-67,-57) #modify the bbox object to the focal extent
plot_box[c(2,4)] <- c(43.3,50)

plot_polygon <- plot_box%>%
                st_as_sfc()%>%
                st_buffer(0.2)%>%
                st_as_sf()%>%
                suppressWarnings()

# plot_box <- plot_box%>%
#             st_as_sfc()%>%
#             st_transform(CanProj)%>%
#             st_bbox()

#Baseline plotting reasters with the primary example animal being Atlantic cod

  #Vulnerability
    vuln_rast_cod <- dat%>%
                     filter(spname=="Gadus morhua")%>%
                     dplyr::select(lon,lat,vuln)%>% #vulnerability from Boyce et al. 2022
                     rasterFromXYZ(.,crs=latlong)%>%
                     crop(.,as_Spatial(plot_polygon))%>%
                     st_as_stars()
    
    vuln_rast_mackerel <- dat%>%
                          filter(spname=="Scomber scombrus")%>%
                          dplyr::select(lon,lat,vuln)%>% #vulnerability from Boyce et al. 2022
                          rasterFromXYZ(.,crs=latlong)%>%
                          crop(.,as_Spatial(plot_polygon))%>%
                          st_as_stars()
    
    vuln_rast_lobster <- dat%>%
                          filter(spname=="Homarus americanus")%>%
                          dplyr::select(lon,lat,vuln)%>% #vulnerability from Boyce et al. 2022
                          rasterFromXYZ(.,crs=latlong)%>%
                          crop(.,as_Spatial(plot_polygon))%>%
                          st_as_stars()
    
    #Sensitivity
    sens_rast <- dat%>%
                filter(spname=="Gadus morhua")%>%
                dplyr::select(lon,lat,sens)%>% #Sensitivity from Boyce et al. 2022
                rasterFromXYZ(.,crs=latlong)%>%
                crop(.,as_Spatial(plot_polygon))%>%
                st_as_stars()
    
    #Exposure
    expo_rast <- dat%>%
                filter(spname=="Gadus morhua")%>%
                dplyr::select(lon,lat,expo)%>% #Explosure from Boyce et al. 2022
                rasterFromXYZ(.,crs=latlong)%>%
                crop(.,as_Spatial(plot_polygon))%>%
                st_as_stars()
    
    #Adaptivitive capacity
    adcap_rast <- dat%>%
                  filter(spname=="Gadus morhua")%>%
                  dplyr::select(lon,lat,adcap)%>% #Adaptive Capacity from Boyce et al. 2022
                  rasterFromXYZ(.,crs=latlong)%>%
                  crop(.,as_Spatial(plot_polygon))%>%
                  st_as_stars()
    
    #general distribution 
    distribution_rast_sf <- vuln_rast_cod%>%st_as_sf(crs=latlong)


#panel a depicting the raster of the analysis
panel_a <- ggplot()+
           geom_sf(data=can_mcn%>%st_transform(latlong),fill="grey70")+
           geom_sf(data=distribution_rast_sf,col="black",fill=NA)+ #add the raster
           geom_sf(data=basemap%>%st_transform(latlong),fill="grey10")+
           labs(fill="Vulnerability",x="",y="")+
           coord_sf(expand=0,xlim=plot_box[c(1,3)],ylim=plot_box[c(2,4)])+
           theme_void()+
           theme(panel.border = element_rect(colour = "black", fill=NA,linewidth =1.5))

panel_b_sens <- ggplot()+
                geom_stars(data=sens_rast)+ #add the raster
                geom_sf(data=distribution_rast_sf,fill=NA,lwd=0.2,col="grey20")+ #add the raster borders
                geom_sf(data=basemap%>%st_transform(latlong),fill="grey30")+
                geom_sf(data=can_mcn%>%st_transform(latlong),fill=NA,col="grey20",lwd=1.1)+    
                scale_fill_gradient(low="white",high="#0673B6",na.value="transparent",limits=c(0.2,1))+
                labs(fill="",x="",y="")+
                coord_sf(expand=0,xlim=plot_box[c(1,3)],ylim=plot_box[c(2,4)])+
                theme_void()+
                theme(legend.position = "none",
                      panel.border = element_rect(colour = "black", fill=NA,linewidth =1.5))

panel_b_expo <- ggplot()+
                geom_stars(data=expo_rast)+ #add the raster
                geom_sf(data=distribution_rast_sf,fill=NA,lwd=0.2,col="grey20")+ #add the raster borders
                geom_sf(data=basemap%>%st_transform(latlong),fill="grey30")+
                geom_sf(data=can_mcn%>%st_transform(latlong),fill=NA,col="black",lwd=1.1)+    
                scale_fill_gradient(low="white",high="#C22036",na.value="transparent",limits=c(0,1))+
                labs(fill="",x="",y="")+
                coord_sf(expand=0,xlim=plot_box[c(1,3)],ylim=plot_box[c(2,4)])+
                theme_void()+
                theme(legend.position = "none",
                      panel.border = element_rect(colour = "black", fill=NA,linewidth =1.5))

panel_b_adcap <- ggplot()+
                 geom_stars(data=adcap_rast)+ #add the raster
                 geom_sf(data=distribution_rast_sf,fill=NA,lwd=0.2,col="grey20")+ #add the raster borders
                 geom_sf(data=basemap%>%st_transform(latlong),fill="grey30")+
                 geom_sf(data=can_mcn%>%st_transform(latlong),fill=NA,col="black",lwd=1.1)+    
                 scale_fill_gradient(low="white",high="#F1922F",na.value="transparent",limits=c(0,1))+
                 labs(fill="",x="",y="")+
                 coord_sf(expand=0,xlim=plot_box[c(1,3)],ylim=plot_box[c(2,4)])+
                 theme_void()+
                 theme(legend.position = "none",
                       panel.border = element_rect(colour = "black", fill=NA,linewidth =1.5))

panel_d_vuln <- ggplot()+
                geom_stars(data=vuln_rast_cod)+ #add the raster
                geom_sf(data=distribution_rast_sf,fill=NA,lwd=0.2,col="grey20")+ #add the raster borders
                geom_sf(data=basemap%>%st_transform(latlong),fill="grey30")+
                geom_sf(data=can_mcn%>%st_transform(latlong),fill=NA,col="black",lwd=1.1)+    
                scale_fill_gradientn(colours=kovesi.rainbow(100),na.value="transparent",breaks=c(seq(0.4,0.8,0.1)))+ #note I did not scale this to 0-1 since the range is only ~0.5 to 0.8 and it will look one colour otherwise
                labs(fill="",x="",y="")+
                coord_sf(expand=0,xlim=plot_box[c(1,3)],ylim=plot_box[c(2,4)])+
                theme_void()+
                theme(panel.border = element_rect(colour = "black", fill=NA,linewidth =1.5),
                      legend.position="none")

panel_e_mackerel <- ggplot()+
                    geom_stars(data=vuln_rast_mackerel)+ #add the raster
                    geom_sf(data=distribution_rast_sf,fill=NA,lwd=0.2,col="grey20")+ #add the raster borders
                    geom_sf(data=basemap%>%st_transform(latlong),fill="grey30")+
                    geom_sf(data=can_mcn%>%st_transform(latlong),fill=NA,col="black",lwd=1.1)+    
                    scale_fill_gradientn(colours=kovesi.rainbow(100),na.value="transparent",breaks=c(seq(0.4,0.8,0.1)))+ #note I did not scale this to 0-1 since the range is only ~0.5 to 0.8 and it will look one colour otherwise
                    labs(fill="",x="",y="")+
                    coord_sf(expand=0,xlim=plot_box[c(1,3)],ylim=plot_box[c(2,4)])+
                    theme_void()+
                    theme(panel.border = element_rect(colour = "black", fill=NA,linewidth =1.5),
                          legend.position="none")

panel_e_lobster <- ggplot()+
                    geom_stars(data=vuln_rast_lobster)+ #add the raster
                    geom_sf(data=distribution_rast_sf,fill=NA,lwd=0.2,col="grey20")+ #add the raster borders
                    geom_sf(data=basemap%>%st_transform(latlong),fill="grey30")+
                    geom_sf(data=can_mcn%>%st_transform(latlong),fill=NA,col="black",lwd=1.1)+    
                    scale_fill_gradientn(colours=kovesi.rainbow(100),na.value="transparent",breaks=c(seq(0.4,0.8,0.1)))+ #note I did not scale this to 0-1 since the range is only ~0.5 to 0.8 and it will look one colour otherwise
                    labs(fill="",x="",y="")+
                    coord_sf(expand=0,xlim=plot_box[c(1,3)],ylim=plot_box[c(2,4)])+
                    theme_void()+
                    theme(panel.border = element_rect(colour = "black", fill=NA,linewidth =1.5),
                          legend.position="none")

#save panel rasters
ggsave("output/demo fig/demo_panel_a_distribution.png",panel_a,width=6,height=6,units="in",dpi=300)
ggsave("output/demo fig/demo_panel_b_sens.png",panel_b_sens,width=6,height=6,units="in",dpi=300)
ggsave("output/demo fig/demo_panel_b_expo.png",panel_b_expo,width=6,height=6,units="in",dpi=300)
ggsave("output/demo fig/demo_panel_b_adcap.png",panel_b_adcap,width=6,height=6,units="in",dpi=300)
ggsave("output/demo fig/demo_panel_d_vuln.png",panel_d_vuln,width=6,height=6,units="in",dpi=300)
ggsave("output/demo fig/demo_panel_e_mackerel.png",panel_e_mackerel,width=6,height=6,units="in",dpi=300)
ggsave("output/demo fig/demo_panel_e_lobster.png",panel_e_lobster,width=6,height=6,units="in",dpi=300)

#save the legend 
png("output/demo fig/panel_d_legend.png")
pal.bands(kovesi.rainbow,n=100)
dev.off()
